# ТЕКУЩАЯ ЛОГИКА АВТОМАТИЧЕСКОЙ СИНХРОНИЗАЦИИ И ПУБЛИКАЦИИ

## 1. СИНХРОНИЗАЦИЯ ОТЗЫВОВ И ВОПРОСОВ

### Частота синхронизации:
- **КАЖДЫЕ 2 ЧАСА** (изначальная настройка из миграции 20251023135010)
- Cron job: `'0 */2 * * *'`
- Название: `sync-ozon-marketplaces`

### За какой период загружаются данные:
- **ВСЕ ОТЗЫВЫ С НАЧАЛА ВРЕМЕН!!!**
- НЕТ временного фильтра `since`
- НЕТ ограничения по дате

### Как работает sync-ozon:
```typescript
// Отзывы
const reviewsResponse = await fetch("https://api-seller.ozon.ru/v1/review/list", {
  method: "POST",
  headers,
  body: JSON.stringify({
    last_id: lastId,        // Пагинация
    limit: 100,             // 100 отзывов за раз
    sort_dir: "DESC",       // От новых к старым
    status: "ALL",          // ВСЕ статусы
    // НЕТ фильтра since!!! ⬅️ ПРОБЛЕМА!
  }),
});

// Вопросы
const questionsResponse = await fetch("https://api-seller.ozon.ru/v1/customer-question/list", {
  method: "POST",
  headers,
  body: JSON.stringify({
    last_id: lastId,
    limit: 100,
    // НЕТ фильтра since!!! ⬅️ ПРОБЛЕМА!
  }),
});
```

### Проблема:
При каждом запуске cron job загружаются **ВСЕ** отзывы и вопросы заново:
- Если у вас 10,000 отзывов → каждые 2 часа обрабатываются все 10,000
- Огромная нагрузка на OZON API
- Медленная синхронизация
- Превышение rate limits

## 2. СИНХРОНИЗАЦИЯ ЧАТОВ

### Частота синхронизации:
- **НЕТ АВТОМАТИЧЕСКОЙ СИНХРОНИЗАЦИИ!**
- Нет cron job для чатов
- Синхронизируются только вручную или через UI

### Как работает sync-chats-api:
```typescript
// Синхронизирует только существующие активные чаты
const { data: existingChats } = await supabase
  .from('chats')
  .select('chat_id, posting_number')
  .eq('marketplace_id', marketplace_id)
  .eq('status', 'active');

// Для каждого чата загружает ВСЮ историю
const historyResponse = await fetch('https://api-seller.ozon.ru/v3/chat/history', {
  body: JSON.stringify({
    chat_id: chatId,
    limit: 1000, // ВСЯ история чата
  }),
});
```

## 3. ПУБЛИКАЦИЯ ОТВЕТОВ (ОТЗЫВЫ + ВОПРОСЫ)

### Частота публикации:
- **КАЖДУЮ МИНУТУ** (очень часто!)
- Cron job: `'* * * * *'`
- Название: `process-scheduled-replies`

### Как работает:
```typescript
// Каждую минуту обрабатывает replies со статусом 'scheduled'
const { data: scheduledReplies } = await supabase
  .from("replies")
  .select("*")
  .eq("status", "scheduled")
  .lte("scheduled_at", new Date().toISOString())
  .limit(10); // По 10 ответов за раз

// Для каждого ответа:
// 1. Меняет статус на 'publishing'
// 2. Отправляет в OZON API
// 3. Меняет статус на 'published' или 'failed'
```

## 4. АВТОГЕНЕРАЦИЯ ОТВЕТОВ

### Частота генерации:
- **КАЖДЫЕ 5 МИНУТ**
- Cron job: `'*/5 * * * *'`
- Название: `auto-generate-drafts-cron`

### Как работает:
```typescript
// Каждые 5 минут генерирует ответы для отзывов segment='unanswered'
const { data: reviews } = await reviewsQuery.limit(200);

// Создает ответы:
// - status='drafted' для режима 'semi' (1-3 звезды)
// - status='scheduled' для режима 'auto' (4-5 звезд)
```

## ИТОГО: ТЕКУЩАЯ ЛОГИКА

### ✅ Что работает хорошо:
1. **Публикация ответов**: каждую минуту, быстро
2. **Автогенерация**: каждые 5 минут, регулярно

### ❌ Проблемы:
1. **Синхронизация отзывов/вопросов**:
   - Загружает ВСЕ отзывы каждые 2 часа
   - НЕТ фильтра по дате
   - Огромная нагрузка на API

2. **Синхронизация чатов**:
   - НЕТ автоматической синхронизации
   - Только вручную

## ЧТО НУЖНО ИСПРАВИТЬ:

### Для отзывов и вопросов:
```typescript
// ДОЛЖНО БЫТЬ:
body: JSON.stringify({
  last_id: lastId,
  limit: 100,
  sort_dir: "DESC",
  status: "ALL",
  since: getDateDaysAgo(7), // ⬅️ Загружать только за последние 7 дней!
})
```

### Для чатов:
- Добавить cron job для автоматической синхронизации чатов (каждые 30 минут?)
- Или синхронизировать чаты вместе с отзывами каждые 2 часа

## РЕКОМЕНДУЕМАЯ ЛОГИКА:

1. **Отзывы/вопросы**: каждые 2 часа, **за последние 7 дней**
2. **Чаты**: каждые 30 минут, только активные
3. **Публикация ответов**: каждую минуту (как есть)
4. **Автогенерация**: каждые 5 минут (как есть)
