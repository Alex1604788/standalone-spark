# OZON Performance Sync: –ü—Ä–∏–º–µ–Ω–µ–Ω–Ω—ã–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

## üî• –ö—Ä–∏—Ç–∏—á–Ω—ã–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

### 1. ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω redirect loop (–ì–õ–ê–í–ù–ê–Ø –ü–†–û–ë–õ–ï–ú–ê!)
**–ü—Ä–æ–±–ª–µ–º–∞**: –§—É–Ω–∫—Ü–∏—è –∑–∞—Ü–∏–∫–ª–∏–≤–∞–ª–∞—Å—å –Ω–∞ 20 —Ä–µ–¥–∏—Ä–µ–∫—Ç–∞—Ö –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Ç–æ–∫–µ–Ω–∞ OZON
**–†–µ—à–µ–Ω–∏–µ**:
- –î–æ–±–∞–≤–ª–µ–Ω `redirect: "manual"` –∫ –∑–∞–ø—Ä–æ—Å—É —Ç–æ–∫–µ–Ω–∞
- –î–æ–±–∞–≤–ª–µ–Ω–æ –¥–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ redirect —Å URL
- –¢–µ–ø–µ—Ä—å —Ñ—É–Ω–∫—Ü–∏—è —è–≤–Ω–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç, –≥–¥–µ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç redirect

**–ö–æ–¥**:
```typescript
const tokenResponse = await fetch("https://performance.ozon.ru/api/client/token", {
  method: "POST",
  headers: { "Content-Type": "application/json" },
  body: JSON.stringify({...}),
  redirect: "manual",  // ‚Üê –î–û–ë–ê–í–õ–ï–ù–û!
});

// –ü—Ä–æ–≤–µ—Ä–∫–∞ redirect
if (tokenResponse.status >= 300 && tokenResponse.status < 400) {
  const location = tokenResponse.headers.get("location");
  console.error("Token redirect:", tokenResponse.status, "->", location);
  // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –æ—à–∏–±–∫—É —Å –¥–µ—Ç–∞–ª—è–º–∏
}
```

### 2. ‚úÖ –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω polling (35 —Å–µ–∫—É–Ω–¥ ‚Üí 13 —Å–µ–∫—É–Ω–¥)
**–ü—Ä–æ–±–ª–µ–º–∞**: Polling –∑–∞–Ω–∏–º–∞–ª —Å–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏, —Ñ—É–Ω–∫—Ü–∏—è —Ç–∞–π–º–∞—É—Ç–∏–ª–∞—Å—å
**–†–µ—à–µ–Ω–∏–µ**:
- –ë—ã–ª–æ: 5s initial delay + 10 attempts √ó 3s = 35 —Å–µ–∫—É–Ω–¥
- –°—Ç–∞–ª–æ: 3s initial delay + 6 attempts √ó 2s = 13 —Å–µ–∫—É–Ω–¥

**–ö–æ–¥**:
```typescript
// –ë—ã–ª–æ:
await pollReportStatus(uuid, accessToken, 10, 5000, 3000);

// –°—Ç–∞–ª–æ:
await pollReportStatus(uuid, accessToken, 6, 3000, 2000);
```

### 3. ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω—ã —è–≤–Ω—ã–µ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è –æ —á–∞—Å—Ç–∏—á–Ω–æ–π —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
**–ü—Ä–æ–±–ª–µ–º–∞**: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –≤–∏–¥–µ–ª, —á—Ç–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω—ã –Ω–µ –≤—Å–µ –∫–∞–º–ø–∞–Ω–∏–∏
**–†–µ—à–µ–Ω–∏–µ**:
- –î–æ–±–∞–≤–ª–µ–Ω —Ñ–ª–∞–≥ `partial_sync: true/false`
- –î–æ–±–∞–≤–ª–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã—Ö/–æ—Å—Ç–∞–≤—à–∏—Ö—Å—è –∫–∞–º–ø–∞–Ω–∏–π
- –î–æ–±–∞–≤–ª–µ–Ω —Å—á–µ—Ç—á–∏–∫ `campaigns_remaining`

**–û—Ç–≤–µ—Ç API —Ç–µ–ø–µ—Ä—å —Å–æ–¥–µ—Ä–∂–∏—Ç**:
```json
{
  "success": true,
  "message": "‚ö†Ô∏è Partial sync: processed 10 out of 340 campaigns. Run sync again to continue.",
  "partial_sync": true,
  "campaigns_total": 340,
  "campaigns_processed": 10,
  "campaigns_remaining": 330,
  "inserted": 42
}
```

## üõ°Ô∏è –£–ª—É—á—à–µ–Ω–∏—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏

### 4. ‚úÖ –î–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö OZON API –≤—ã–∑–æ–≤–æ–≤
–î–æ–±–∞–≤–ª–µ–Ω–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ HTTP —Å—Ç–∞—Ç—É—Å–æ–≤ –¥–ª—è:
- ‚úÖ –ü–æ–ª—É—á–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞
- ‚úÖ –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –∫–∞–º–ø–∞–Ω–∏–π
- ‚úÖ –ó–∞–ø—Ä–æ—Å –æ—Ç—á–µ—Ç–∞
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –æ—Ç—á–µ—Ç–∞ (polling)
- ‚úÖ –°–∫–∞—á–∏–≤–∞–Ω–∏–µ –æ—Ç—á–µ—Ç–∞

**–ü—Ä–∏–º–µ—Ä –ª–æ–≥–æ–≤**:
```
Token response: 200 OK
Campaigns list response: 200 OK
Report request response: 200 OK
Status check response: 200 OK
Download response: 200 OK
```

### 5. ‚úÖ –ó–∞—â–∏—Ç–∞ –æ—Ç redirect –¥–ª—è –≤—Å–µ—Ö endpoints
–î–æ–±–∞–≤–ª–µ–Ω `redirect: "manual"` –¥–ª—è:
- `/api/client/token` (–ø–æ–ª—É—á–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞)
- `/api/client/campaign` (—Å–ø–∏—Å–æ–∫ –∫–∞–º–ø–∞–Ω–∏–π)
- `/api/client/statistics` (–∑–∞–ø—Ä–æ—Å –æ—Ç—á–µ—Ç–∞)
- `/api/client/statistics` GET (–ø—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞)
- `/api/client/statistics/{uuid}` (—Å–∫–∞—á–∏–≤–∞–Ω–∏–µ)

## üìä –¢–µ–∫—É—â–∏–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è

### ‚ö†Ô∏è –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ 10 –∫–∞–º–ø–∞–Ω–∏–π –∑–∞ —Ä–∞–∑
**–ü—Ä–∏—á–∏–Ω–∞**: OZON API –ª–∏–º–∏—Ç ‚Äî 1 –∞–∫—Ç–∏–≤–Ω—ã–π –∑–∞–ø—Ä–æ—Å –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ
**–†–µ—à–µ–Ω–∏–µ**: –ó–∞–ø—É—Å–∫–∞–π—Ç–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ä–∞–∑ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –≤—Å–µ—Ö –∫–∞–º–ø–∞–Ω–∏–π

### ‚ö†Ô∏è –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π –ø–µ—Ä–∏–æ–¥ ‚Äî 62 –¥–Ω—è
**–ü—Ä–∏—á–∏–Ω–∞**: –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ OZON Performance API
**–†–µ—à–µ–Ω–∏–µ**: –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ "–ó–∞ 7 –¥–Ω–µ–π" –∏–ª–∏ "–ó–∞ 30 –¥–Ω–µ–π" –≤–º–µ—Å—Ç–æ "–ó–∞ 90 –¥–Ω–µ–π"

## üöÄ –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

### 1. –î–µ–ø–ª–æ–π –∫–æ–¥–∞ –≤ Supabase
–°–∫–æ–ø–∏—Ä—É–π—Ç–µ –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π –∫–æ–¥ –∏–∑:
```
https://github.com/Alex1604788/standalone-spark/blob/claude/review-repository-015QiEMXVebETdBjXVAyQ98N/supabase/functions/sync-ozon-performance/index.ts
```

### 2. –í—ã–ø–æ–ª–Ω–∏—Ç—å SQL fix –¥–ª—è precision
–§–∞–π–ª: `FIX_OZON_TABLE_PRECISION.sql`
–≠—Ç–æ –∏—Å–ø—Ä–∞–≤–∏—Ç –æ—à–∏–±–∫—É "precision 0, scale 2 must round to absolute value less than 10^3"

### 3. –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å
–ó–∞–ø—É—Å—Ç–∏—Ç—å —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é "–ó–∞ 7 –¥–Ω–µ–π" –∏ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å:
- ‚úÖ –¢–æ–∫–µ–Ω –ø–æ–ª—É—á–µ–Ω —É—Å–ø–µ—à–Ω–æ (–Ω–µ—Ç redirect)
- ‚úÖ –î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ –±–∞–∑—É (–Ω–µ—Ç –æ—à–∏–±–∫–∏ precision)
- ‚úÖ –í –æ—Ç–≤–µ—Ç–µ –≤–∏–¥–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ partial sync

## üìù Commit history

- `2d1545d` - Fix redirect loop and optimize polling intervals
- `bab4e2b` - Add redirect detection and detailed logging to OZON sync
- `6499d43` - Update sync-ozon-performance with ZIP extraction and sequential processing
- `18637a2` - Add OZON Performance API implementation and documentation

## üîç –ê–Ω–∞–ª–∏–∑ –ø—Ä–∏–º–µ–Ω–µ–Ω –∏–∑

–î–æ–∫—É–º–µ–Ω—Ç: "sync-ozon-performance: –æ—Å–Ω–æ–≤–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã –∏ –ø—É—Ç–∏ —Ä–µ—à–µ–Ω–∏—è"

–ü—Ä–∏–º–µ–Ω–µ–Ω—ã —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:
- ‚úÖ #1: –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è polling intervals
- ‚úÖ #3: –Ø–≤–Ω–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –Ω–µ–ø–æ–ª–Ω–æ–π –≤—ã–±–æ—Ä–∫–µ
- ‚úÖ #4: –£–ª—É—á—à–µ–Ω–Ω–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –æ—à–∏–±–æ–∫ —Ç–æ–∫–µ–Ω–∞
- ‚è≥ #2: –ü–∞—Ä—Å–∏–Ω–≥ –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä–æ–≤ (—É–∂–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω —Ä–∞–Ω–µ–µ, —Ç—Ä–µ–±—É–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏)
