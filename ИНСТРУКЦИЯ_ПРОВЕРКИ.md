# üîç –ò–ù–°–¢–†–£–ö–¶–ò–Ø –ü–û –ü–†–û–í–ï–†–ö–ï –°–ò–ù–•–†–û–ù–ò–ó–ê–¶–ò–ò

## ‚úÖ –¢–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å –∫–æ–¥–∞

### 1. Edge Function
- **–í–µ—Ä—Å–∏—è**: `3.0.8-fix-ozon-api-limit`
- **–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ**: –ü–∞—É–∑–∞ –º–µ–∂–¥—É –∫–∞–º–ø–∞–Ω–∏—è–º–∏ —É–≤–µ–ª–∏—á–µ–Ω–∞ —Å 3 –¥–æ 90 —Å–µ–∫—É–Ω–¥
- **–°—Ç–∞—Ç—É—Å**: ‚úÖ –ó–∞–∫–æ–º–º–∏—á–µ–Ω–æ –∏ –∑–∞–ø—É—à–µ–Ω–æ (–∞–≤—Ç–æ–¥–µ–ø–ª–æ–π —á–µ—Ä–µ–∑ GitHub Actions)

### 2. –ú–∏–≥—Ä–∞—Ü–∏–∏
- **VIEW –¥–ª—è –∞–≤—Ç–æ—Å—É–º–º–∏—Ä–æ–≤–∞–Ω–∏—è**: `20260112000000_create_ozon_performance_summary_view.sql` ‚úÖ
- **CRON —Å service_role key**: `20260112_fix_ozon_performance_cron_service_key.sql` ‚úÖ

---

## üöÄ –ß–¢–û –ù–£–ñ–ù–û –°–î–ï–õ–ê–¢–¨ –°–ï–ô–ß–ê–°

### –®–∞–≥ 1: –ë—ã—Å—Ç—Ä–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è

1. –û—Ç–∫—Ä–æ–π—Ç–µ Supabase SQL Editor:
   ```
   https://supabase.com/dashboard/project/bkmicyguzlwampuindff/sql
   ```

2. –û—Ç–∫—Ä–æ–π—Ç–µ —Ñ–∞–π–ª `–ë–´–°–¢–†–ê–Ø_–ü–†–û–í–ï–†–ö–ê.sql`

3. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ –≤–µ—Å—å –∫–æ–¥ –∏ –≤—Å—Ç–∞–≤—å—Ç–µ –≤ SQL Editor

4. –ù–∞–∂–º–∏—Ç–µ **RUN** ‚ñ∂Ô∏è

**–ß—Ç–æ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è:**
- ‚úÖ –°—Ç–∞—Ç—É—Å –ø–æ—Å–ª–µ–¥–Ω–µ–π —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
- ‚úÖ –ü–µ—Ä–∏–æ–¥ –ø–æ–∫—Ä—ã—Ç–∏—è –¥–∞–Ω–Ω—ã–º–∏ (–Ω—É–∂–Ω–æ ‚â•62 –¥–Ω—è)
- ‚úÖ –ù–∞–ª–∏—á–∏–µ VIEW –¥–ª—è –∞–≤—Ç–æ—Å—É–º–º–∏—Ä–æ–≤–∞–Ω–∏—è
- ‚úÖ –ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å —Ä–∞–±–æ—Ç—ã —Å—É–º–º–∏—Ä–æ–≤–∞–Ω–∏—è
- ‚úÖ –ò—Ç–æ–≥–æ–≤–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞

---

## üìã –ò–ù–¢–ï–†–ü–†–ï–¢–ê–¶–ò–Ø –†–ï–ó–£–õ–¨–¢–ê–¢–û–í

### –°—Ü–µ–Ω–∞—Ä–∏–π A: ‚úÖ –í—Å—ë —Ä–∞–±–æ—Ç–∞–µ—Ç –æ—Ç–ª–∏—á–Ω–æ

**–†–µ–∑—É–ª—å—Ç–∞—Ç—ã:**
```
1Ô∏è‚É£ –ü–û–°–õ–ï–î–ù–Ø–Ø –°–ò–ù–•–†–û–ù–ò–ó–ê–¶–ò–Ø: status = 'completed', result = '‚úÖ OK'
2Ô∏è‚É£ –ü–ï–†–ò–û–î –î–ê–ù–ù–´–•: days ‚â• 62, result = '‚úÖ –ï—Å—Ç—å 62+ –¥–Ω—è'
3Ô∏è‚É£ VIEW: result = '‚úÖ VIEW —Å—É—â–µ—Å—Ç–≤—É–µ—Ç'
4Ô∏è‚É£ –°–£–ú–ú–ò–†–û–í–ê–ù–ò–ï: result = '‚úÖ –°—É–º–º–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç'
```

**–î–µ–π—Å—Ç–≤–∏—è:**
- ‚úÖ –ù–∏—á–µ–≥–æ –¥–µ–ª–∞—Ç—å –Ω–µ –Ω—É–∂–Ω–æ! –°–∏—Å—Ç–µ–º–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- –ú–æ–∂–µ—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `ozon_performance_summary` –≤–æ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–µ

---

### –°—Ü–µ–Ω–∞—Ä–∏–π B: ‚ö†Ô∏è –î–∞–Ω–Ω—ã—Ö –º–µ–Ω—å—à–µ 62 –¥–Ω–µ–π

**–†–µ–∑—É–ª—å—Ç–∞—Ç—ã:**
```
2Ô∏è‚É£ –ü–ï–†–ò–û–î –î–ê–ù–ù–´–•: days < 62, result = '‚ö†Ô∏è –ú–µ–Ω—å—à–µ 62 –¥–Ω–µ–π'
```

**–î–µ–π—Å—Ç–≤–∏—è:**

1. –ó–∞–ø—É—Å—Ç–∏—Ç–µ –ø–æ–ª–Ω—É—é —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é:
   ```sql
   SELECT public.trigger_ozon_performance_sync(
     '84b1d0f5-6750-407c-9b04-28c051972162'::uuid,
     'full'
   );
   ```

2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å—Ç–∞—Ç—É—Å —á–µ—Ä–µ–∑ 10-15 –º–∏–Ω—É—Ç:
   ```sql
   SELECT status, campaigns_count, rows_inserted
   FROM ozon_sync_history
   WHERE marketplace_id = '84b1d0f5-6750-407c-9b04-28c051972162'
   ORDER BY started_at DESC
   LIMIT 1;
   ```

3. **–í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è**: ~30-40 –º–∏–Ω—É—Ç (55 –∫–∞–º–ø–∞–Ω–∏–π)

---

### –°—Ü–µ–Ω–∞—Ä–∏–π C: ‚ùå VIEW –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç

**–†–µ–∑—É–ª—å—Ç–∞—Ç—ã:**
```
3Ô∏è‚É£ VIEW: result = '‚ùå VIEW –Ω–µ –Ω–∞–π–¥–µ–Ω'
```

**–î–µ–π—Å—Ç–≤–∏—è:**

1. –ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é VIEW:
   ```bash
   # –í —Ç–µ—Ä–º–∏–Ω–∞–ª–µ –ø—Ä–æ–µ–∫—Ç–∞
   npx supabase db push
   ```

   –ò–õ–ò –≤—Ä—É—á–Ω—É—é –≤ SQL Editor:

2. –û—Ç–∫—Ä–æ–π—Ç–µ —Ñ–∞–π–ª:
   ```
   supabase/migrations/20260112000000_create_ozon_performance_summary_view.sql
   ```

3. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ –≤–µ—Å—å –∫–æ–¥ –∏ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ –≤ SQL Editor

4. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —á—Ç–æ VIEW —Å–æ–∑–¥–∞–ª—Å—è:
   ```sql
   SELECT table_name FROM information_schema.tables
   WHERE table_name = 'ozon_performance_summary';
   ```

---

### –°—Ü–µ–Ω–∞—Ä–∏–π D: ‚ùå –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–∏–ª–∞—Å—å —Å –æ—à–∏–±–∫–æ–π

**–†–µ–∑—É–ª—å—Ç–∞—Ç—ã:**
```
1Ô∏è‚É£ –ü–û–°–õ–ï–î–ù–Ø–Ø –°–ò–ù–•–†–û–ù–ò–ó–ê–¶–ò–Ø: status = 'failed', result = '‚ùå [—Ç–µ–∫—Å—Ç –æ—à–∏–±–∫–∏]'
```

**–î–µ–π—Å—Ç–≤–∏—è:**

1. –ü–æ—Å–º–æ—Ç—Ä–∏—Ç–µ –ø–æ–ª–Ω—ã–π —Ç–µ–∫—Å—Ç –æ—à–∏–±–∫–∏:
   ```sql
   SELECT error_message, error_details
   FROM ozon_sync_history
   WHERE marketplace_id = '84b1d0f5-6750-407c-9b04-28c051972162'
   ORDER BY started_at DESC
   LIMIT 1;
   ```

2. –ï—Å–ª–∏ –æ—à–∏–±–∫–∞ "–ü—Ä–µ–≤—ã—à–µ–Ω –ª–∏–º–∏—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤":
   - ‚è≥ –ü–æ–¥–æ–∂–¥–∏—Ç–µ 2-3 –º–∏–Ω—É—Ç—ã (–∞–≤—Ç–æ–¥–µ–ø–ª–æ–π –Ω–æ–≤–æ–π –≤–µ—Ä—Å–∏–∏)
   - üîÑ –ó–∞–ø—É—Å—Ç–∏—Ç–µ —Ç–µ—Å—Ç–æ–≤—É—é —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é —Å–Ω–æ–≤–∞

3. –ï—Å–ª–∏ –¥—Ä—É–≥–∞—è –æ—à–∏–±–∫–∞:
   - –ü—Ä–æ–≤–µ—Ä—å—Ç–µ API credentials:
     ```sql
     SELECT marketplace_name, has_valid_credentials
     FROM marketplaces
     WHERE id = '84b1d0f5-6750-407c-9b04-28c051972162';
     ```

---

## üéØ –ü–û–°–õ–ï –£–°–ü–ï–®–ù–û–ô –ü–†–û–í–ï–†–ö–ò

### –û–±–Ω–æ–≤–∏—Ç—å —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥ (–µ—Å–ª–∏ –µ—â–µ –Ω–µ —Å–¥–µ–ª–∞–Ω–æ)

–¢–µ–ø–µ—Ä—å –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ `ozon_performance_summary` –≤–º–µ—Å—Ç–æ `ozon_performance_daily`:

```typescript
// ‚ùå –°–¢–ê–†–´–ô –ö–û–î
const { data } = await supabase
  .from('ozon_performance_daily')
  .select('*');

// ‚úÖ –ù–û–í–´–ô –ö–û–î
const { data } = await supabase
  .from('ozon_performance_summary')
  .select('*');

// data —É–∂–µ —Å–æ–¥–µ—Ä–∂–∏—Ç:
// - total_orders (–∞–≤—Ç–æ—Å—É–º–º–∞ orders + orders_model)
// - total_revenue (–∞–≤—Ç–æ—Å—É–º–º–∞ revenue + revenue_model)
// - –ø–µ—Ä–µ—Å—á–∏—Ç–∞–Ω–Ω—ã–µ ROI, –î–†–†, –∫–æ–Ω–≤–µ—Ä—Å–∏—é
```

---

## üìä –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–´–ï –ü–†–û–í–ï–†–ö–ò

### –ö–æ–º–ø–ª–µ–∫—Å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)

–ó–∞–ø—É—Å—Ç–∏—Ç–µ `–ö–û–ú–ü–õ–ï–ö–°–ù–ê–Ø_–ü–†–û–í–ï–†–ö–ê_–°–ò–ù–•–†–û–ù–ò–ó–ê–¶–ò–ò.sql` –¥–ª—è –¥–µ—Ç–∞–ª—å–Ω–æ–π –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏:
- –ò—Å—Ç–æ—Ä–∏—è –ø–æ—Å–ª–µ–¥–Ω–∏—Ö 10 —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–π
- –¢–æ–ø-5 –∫–∞–º–ø–∞–Ω–∏–π –ø–æ –∑–∞–∫–∞–∑–∞–º
- –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã vs VIEW
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–∏—Å—à–∏—Ö —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–π

---

## ‚öôÔ∏è –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–ê–Ø –°–ò–ù–•–†–û–ù–ò–ó–ê–¶–ò–Ø

### CRON Jobs –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã:

1. **–ï–∂–µ–¥–Ω–µ–≤–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è**
   - –í—Ä–µ–º—è: 03:00 UTC (06:00 –ú–°–ö)
   - –†–µ–∂–∏–º: `daily` (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 7 –¥–Ω–µ–π)

2. **–ü–æ–ª–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è**
   - –í—Ä–µ–º—è: –ö–∞–∂–¥–æ–µ –≤–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ 04:00 UTC
   - –†–µ–∂–∏–º: `full` (62 –¥–Ω—è)

### –ü—Ä–æ–≤–µ—Ä–∏—Ç—å CRON:
```sql
SELECT
  jobname,
  schedule,
  active,
  command
FROM cron.job
WHERE jobname LIKE '%ozon%';
```

---

## üîß –§–ê–ô–õ–´ –î–õ–Ø –†–ê–ë–û–¢–´

| –§–∞–π–ª | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ |
|------|------------|
| `–ë–´–°–¢–†–ê–Ø_–ü–†–û–í–ï–†–ö–ê.sql` | ‚ö° –ë—ã—Å—Ç—Ä–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ 5 –∫–ª—é—á–µ–≤—ã—Ö –ø–æ–∫–∞–∑–∞—Ç–µ–ª–µ–π |
| `–ö–û–ú–ü–õ–ï–ö–°–ù–ê–Ø_–ü–†–û–í–ï–†–ö–ê_–°–ò–ù–•–†–û–ù–ò–ó–ê–¶–ò–ò.sql` | üìä –î–µ—Ç–∞–ª—å–Ω–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ —Å–∏—Å—Ç–µ–º—ã |
| `–ü–†–û–í–ï–†–ö–ê_–ò_–ó–ê–ü–£–°–ö_–ü–û–õ–ù–û–ô_–°–ò–ù–•–†–û–ù–ò–ó–ê–¶–ò–ò.sql` | üöÄ –ó–∞–ø—É—Å–∫ –ø–æ–ª–Ω–æ–π —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –∑–∞ 62 –¥–Ω—è |
| `CREATE_VIEW_AUTO_SUM.sql` | üëÅÔ∏è –°–æ–∑–¥–∞–Ω–∏–µ VIEW (–µ—Å–ª–∏ –Ω–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∞ –º–∏–≥—Ä–∞—Ü–∏—è) |
| `–ò–ù–°–¢–†–£–ö–¶–ò–Ø_–ü–†–û–í–ï–†–ö–ò.md` | üìñ –≠—Ç–æ—Ç —Ñ–∞–π–ª |

---

## üéâ –ò–¢–û–ì

### ‚úÖ –ï—Å–ª–∏ –≤—Å—ë —Ä–∞–±–æ—Ç–∞–µ—Ç:
1. –ü–æ—Å–ª–µ–¥–Ω—è—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è: `completed` –±–µ–∑ –æ—à–∏–±–æ–∫
2. –ü–µ—Ä–∏–æ–¥ –¥–∞–Ω–Ω—ã—Ö: ‚â•62 –¥–Ω—è
3. VIEW —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç
4. –°—É–º–º–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ

### üöÄ –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏:
- –ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å `ozon_performance_summary` –≤–æ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥
- –°–æ–∑–¥–∞—Ç—å –¥–∞—à–±–æ—Ä–¥ —Å –º–µ—Ç—Ä–∏–∫–∞–º–∏
- –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –∞–ª–µ—Ä—Ç—ã –Ω–∞ –æ—à–∏–±–∫–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏

---

**–£–¥–∞—á–∏!** üçÄ
