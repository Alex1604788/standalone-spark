#!/bin/bash

# ============================================================================
# –°–ö–†–ò–ü–¢ –î–õ–Ø –ó–ê–ü–£–°–ö–ê –ê–ù–ê–õ–ò–ó–ê –õ–û–ö–ê–õ–¨–ù–û (–≤–Ω–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ Claude Code)
# ============================================================================
#
# –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä Claude Code –Ω–µ –∏–º–µ–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ –≤–Ω–µ—à–Ω–µ–π —Å–µ—Ç–∏ –∏–∑-–∑–∞ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π DNS/SSL
# –ü–æ—ç—Ç–æ–º—É —ç—Ç–æ—Ç —Å–∫—Ä–∏–ø—Ç –Ω—É–∂–Ω–æ –∑–∞–ø—É—Å–∫–∞—Ç—å –Ω–∞ –¢–í–û–ï–ú –õ–û–ö–ê–õ–¨–ù–û–ú –∫–æ–º–ø—å—é—Ç–µ—Ä–µ
#
# –¢–†–ï–ë–û–í–ê–ù–ò–Ø:
# - PostgreSQL client (psql) —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω
# - –î–æ—Å—Ç—É–ø –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É
#
# –ò–°–ü–û–õ–¨–ó–û–í–ê–ù–ò–ï:
# 1. –°–∫–æ–ø–∏—Ä—É–π —ç—Ç–æ—Ç —Ñ–∞–π–ª –Ω–∞ —Å–≤–æ–π –ª–æ–∫–∞–ª—å–Ω—ã–π –∫–æ–º–ø—å—é—Ç–µ—Ä
# 2. –°–∫–æ–ø–∏—Ä—É–π —Ç–∞–∫–∂–µ —Ñ–∞–π–ª AUTO_ANALYZE_REPLIES.sql
# 3. –ó–∞–ø—É—Å—Ç–∏: bash run-analysis-local.sh
# ============================================================================

set -e

# –¶–≤–µ—Ç–∞ –¥–ª—è –≤—ã–≤–æ–¥–∞
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

echo -e "${BLUE}üîç –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–ò–ô –ê–ù–ê–õ–ò–ó –¢–ê–ë–õ–ò–¶–´ REPLIES${NC}"
echo "========================================================================"
echo ""

# –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
DB_PASSWORD="bWWDsoxjJ0YMbSbl"
DB_HOST="db.bkmicyguzlwampuindff.supabase.co"
DB_PORT="5432"
DB_USER="postgres.bkmicyguzlwampuindff"
DB_NAME="postgres"

# Connection string
DB_URL="postgresql://${DB_USER}:${DB_PASSWORD}@${DB_HOST}:${DB_PORT}/${DB_NAME}"

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ psql
if ! command -v psql &> /dev/null; then
    echo -e "${RED}‚ùå –û–®–ò–ë–ö–ê: psql –Ω–µ –Ω–∞–π–¥–µ–Ω!${NC}"
    echo ""
    echo "–£—Å—Ç–∞–Ω–æ–≤–∏ PostgreSQL client:"
    echo "  macOS:   brew install postgresql"
    echo "  Ubuntu:  sudo apt-get install postgresql-client"
    echo "  Windows: https://www.postgresql.org/download/windows/"
    echo ""
    exit 1
fi

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ SQL —Ñ–∞–π–ª–∞
if [ ! -f "AUTO_ANALYZE_REPLIES.sql" ]; then
    echo -e "${RED}‚ùå –û–®–ò–ë–ö–ê: –§–∞–π–ª AUTO_ANALYZE_REPLIES.sql –Ω–µ –Ω–∞–π–¥–µ–Ω!${NC}"
    echo "–°–∫–æ–ø–∏—Ä—É–π –µ–≥–æ –∏–∑ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è –≤ —ç—Ç—É –∂–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é"
    exit 1
fi

echo -e "${GREEN}‚úÖ psql –Ω–∞–π–¥–µ–Ω: $(psql --version)${NC}"
echo -e "${GREEN}‚úÖ SQL —Ñ–∞–π–ª –Ω–∞–π–¥–µ–Ω${NC}"
echo ""

# –¢–µ—Å—Ç–∏—Ä—É–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
echo -e "${YELLOW}üîå –ü—Ä–æ–≤–µ—Ä—è—é –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö...${NC}"
if PGPASSWORD="${DB_PASSWORD}" psql "${DB_URL}" -c "SELECT 1;" > /dev/null 2>&1; then
    echo -e "${GREEN}‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ!${NC}"
    echo ""
else
    echo -e "${RED}‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö${NC}"
    echo ""
    echo "–í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã:"
    echo "  1. –ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å"
    echo "  2. –ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É"
    echo "  3. Supabase –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω"
    echo ""
    exit 1
fi

# –ó–∞–ø—É—Å–∫–∞–µ–º –∞–Ω–∞–ª–∏–∑
echo -e "${BLUE}üöÄ –ó–∞–ø—É—Å–∫–∞—é –∞–Ω–∞–ª–∏–∑...${NC}"
echo "========================================================================"
echo ""

export PGPASSWORD="${DB_PASSWORD}"
psql "${DB_URL}" -f AUTO_ANALYZE_REPLIES.sql

echo ""
echo "========================================================================"
echo -e "${GREEN}‚úÖ –ê–ù–ê–õ–ò–ó –ó–ê–í–ï–†–®–ï–ù!${NC}"
echo ""
echo -e "${YELLOW}üí° –¢–µ–ø–µ—Ä—å —Å–∫–æ–ø–∏—Ä—É–π –í–°–ï —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –≤—ã—à–µ –∏ –æ—Ç–ø—Ä–∞–≤—å Claude!${NC}"
echo ""
