# üöÄ –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ –Ω–∞—Å—Ç—Ä–æ–π–∫–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ OZON Performance API

## ‚úÖ –ß—Ç–æ —É–∂–µ —Å–¥–µ–ª–∞–Ω–æ

1. ‚úÖ –°–æ–∑–¥–∞–Ω `.env.local` —Ñ–∞–π–ª —Å —Ç–æ–∫–µ–Ω–∞–º–∏ Supabase
2. ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω—ã CRON jobs –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è service_role key
3. ‚úÖ –°–æ–∑–¥–∞–Ω–∞ –º–∏–≥—Ä–∞—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫
4. ‚úÖ –ü—Ä–æ–≤–µ—Ä–µ–Ω–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö

## üìã –ß—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å

### –®–∞–≥ 1: –ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏ –≤ Supabase

1. –û—Ç–∫—Ä–æ–π—Ç–µ **Supabase Dashboard**: https://supabase.com/dashboard
2. –í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–æ–µ–∫—Ç **bkmicyguzlwampuindff**
3. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ **SQL Editor** (–ª–µ–≤–æ–µ –º–µ–Ω—é)
4. –û—Ç–∫—Ä–æ–π—Ç–µ —Ñ–∞–π–ª `SETUP_SERVICE_ROLE_KEY.sql` –≤ —Ä–µ–¥–∞–∫—Ç–æ—Ä–µ
5. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ –≤–µ—Å—å –∫–æ–¥ –∏ –≤—Å—Ç–∞–≤—å—Ç–µ –≤ SQL Editor
6. –ù–∞–∂–º–∏—Ç–µ **RUN** (–∏–ª–∏ F5)
7. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–∏–º–µ–Ω–∏–ª–∏—Å—å:
   ```sql
   SELECT name, setting FROM pg_settings WHERE name LIKE 'app.settings.%';
   ```

8. –¢–µ–ø–µ—Ä—å –ø—Ä–∏–º–µ–Ω–∏—Ç–µ –Ω–æ–≤—É—é –º–∏–≥—Ä–∞—Ü–∏—é –¥–ª—è CRON jobs:
   - –û—Ç–∫—Ä–æ–π—Ç–µ —Ñ–∞–π–ª `supabase/migrations/20260112_fix_ozon_performance_cron_service_key.sql`
   - –°–∫–æ–ø–∏—Ä—É–π—Ç–µ –≤–µ—Å—å –∫–æ–¥
   - –í—Å—Ç–∞–≤—å—Ç–µ –≤ SQL Editor –∏ –Ω–∞–∂–º–∏—Ç–µ **RUN**

### –®–∞–≥ 2: –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –º–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å –∏ API credentials

1. –í Supabase Dashboard –ø–µ—Ä–µ–π–¥–∏—Ç–µ –≤ **Table Editor**
2. –û—Ç–∫—Ä–æ–π—Ç–µ —Ç–∞–±–ª–∏—Ü—É **marketplaces**
3. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —É –≤–∞—Å –µ—Å—Ç—å –∑–∞–ø–∏—Å—å —Å —Ç–∏–ø–æ–º `ozon`
4. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ **ID** –º–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å–∞ (UUID)

5. –û—Ç–∫—Ä–æ–π—Ç–µ —Ç–∞–±–ª–∏—Ü—É **marketplace_api_credentials**
6. –°–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—É—é –∑–∞–ø–∏—Å—å (–∏–ª–∏ –æ–±–Ω–æ–≤–∏—Ç–µ —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é):
   - `marketplace_id`: UUID –≤–∞—à–µ–≥–æ –º–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å–∞ –∏–∑ –ø.4
   - `api_type`: `performance`
   - `client_id`: –≤–∞—à OZON Performance API Client ID
   - `client_secret`: –≤–∞—à OZON Performance API Client Secret
   - `auto_sync_enabled`: `true` (–¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏)
   - `sync_frequency`: `daily`
   - `is_active`: `true`

### –®–∞–≥ 3: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è PostgreSQL

1. –í Supabase Dashboard ‚Üí **Database** ‚Üí **Extensions**
2. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤–∫–ª—é—á–µ–Ω—ã:
   - ‚úÖ `pg_cron` - –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏—Ö –∑–∞–¥–∞—á
   - ‚úÖ `pg_net` - –¥–ª—è HTTP –∑–∞–ø—Ä–æ—Å–æ–≤ –∏–∑ –ë–î

### –®–∞–≥ 4: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å CRON jobs

–í—ã–ø–æ–ª–Ω–∏—Ç–µ –≤ SQL Editor:

```sql
-- –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –≤—Å–µ CRON jobs
SELECT * FROM cron.job WHERE jobname LIKE '%ozon%';

-- –î–æ–ª–∂–Ω—ã –±—ã—Ç—å 2 –∑–∞–¥–∞—á–∏:
-- 1. ozon-performance-daily-sync (–∫–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ 03:00 UTC)
-- 2. ozon-performance-weekly-sync (–∫–∞–∂–¥–æ–µ –≤–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ –≤ 04:00 UTC)
```

### –®–∞–≥ 5: –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é –≤—Ä—É—á–Ω—É—é

```sql
-- –ó–∞–º–µ–Ω–∏—Ç–µ YOUR_MARKETPLACE_ID –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã–π UUID –º–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å–∞
SELECT public.trigger_ozon_performance_sync(
  'YOUR_MARKETPLACE_ID'::uuid,
  'daily'
);

-- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–π
SELECT * FROM ozon_sync_history ORDER BY started_at DESC LIMIT 10;

-- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–∞–Ω–Ω—ã–µ
SELECT * FROM ozon_performance_daily ORDER BY imported_at DESC LIMIT 100;
```

### –®–∞–≥ 6: –ó–∞–∫–æ–º–º–∏—Ç–∏—Ç—å –∏ –∑–∞–ø—É—à–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è

```bash
git add .
git commit -m "fix: –ò—Å–ø—Ä–∞–≤–∏—Ç—å CRON jobs –¥–ª—è sync-ozon-performance - –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å service_role key"
git push -u origin claude/initial-setup-hN0XE
```

## üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã

### –ü—Ä–æ–≤–µ—Ä–∫–∞ —á–µ—Ä–µ–∑ —Ñ—É–Ω–∫—Ü–∏—é

–í—ã –º–æ–∂–µ—Ç–µ –≤—ã–∑–≤–∞—Ç—å Edge Function –Ω–∞–ø—Ä—è–º—É—é —á–µ—Ä–µ–∑ curl:

```bash
curl -X POST https://bkmicyguzlwampuindff.supabase.co/functions/v1/sync-ozon-performance \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJrbWljeWd1emx3YW1wdWluZGZmIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc2NDY5NTAyMywiZXhwIjoyMDgwMjcxMDIzfQ.F6BnFa-RMYI__r-6bhaLzgZ-7_U-mwvgW_-8fgen0Dk" \
  -d '{
    "marketplace_id": "YOUR_MARKETPLACE_ID",
    "sync_period": "daily",
    "test": true
  }'
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–æ–≤ Edge Function

1. Supabase Dashboard ‚Üí **Edge Functions** ‚Üí **sync-ozon-performance**
2. –û—Ç–∫—Ä–æ–π—Ç–µ –≤–∫–ª–∞–¥–∫—É **Logs**
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ—Å–ª–µ–¥–Ω–∏–µ –≤—ã–∑–æ–≤—ã –∏ –æ—à–∏–±–∫–∏

### –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∞–±–ª–∏—Ü

```sql
-- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ API
SELECT
  m.name as marketplace_name,
  mac.api_type,
  mac.auto_sync_enabled,
  mac.last_sync_at,
  mac.is_active,
  mac.last_error
FROM marketplace_api_credentials mac
JOIN marketplaces m ON m.id = mac.marketplace_id
WHERE mac.api_type = 'performance';

-- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–π
SELECT
  status,
  trigger_type,
  period_from,
  period_to,
  campaigns_count,
  rows_inserted,
  started_at,
  completed_at,
  metadata->>'version' as version
FROM ozon_sync_history
ORDER BY started_at DESC
LIMIT 10;

-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –¥–∞–Ω–Ω—ã–º
SELECT
  stat_date,
  COUNT(DISTINCT sku) as products_count,
  COUNT(DISTINCT campaign_id) as campaigns_count,
  SUM(money_spent) as total_spent,
  SUM(orders) as total_orders,
  SUM(revenue) as total_revenue
FROM ozon_performance_daily
WHERE stat_date >= CURRENT_DATE - INTERVAL '7 days'
GROUP BY stat_date
ORDER BY stat_date DESC;
```

## ‚ö†Ô∏è –í–∞–∂–Ω—ã–µ –∑–∞–º–µ—á–∞–Ω–∏—è

1. **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å**: Service Role Key –∏–º–µ–µ—Ç –ø–æ–ª–Ω—ã–µ –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö. –ù–∏–∫–æ–≥–¥–∞ –Ω–µ –ø–µ—Ä–µ–¥–∞–≤–∞–π—Ç–µ –µ–≥–æ —Ç—Ä–µ—Ç—å–∏–º –ª–∏—Ü–∞–º.

2. **CRON —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ**:
   - –ï–∂–µ–¥–Ω–µ–≤–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è: 03:00 UTC (06:00 –ú–°–ö)
   - –ü–æ–ª–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è: –∫–∞–∂–¥–æ–µ –≤–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ –≤ 04:00 UTC (07:00 –ú–°–ö)

3. **–õ–∏–º–∏—Ç—ã OZON API**:
   - –§—É–Ω–∫—Ü–∏—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è API
   - –ü—Ä–∏ –ø—Ä–µ–≤—ã—à–µ–Ω–∏–∏ –ª–∏–º–∏—Ç–∞ –±—É–¥–µ—Ç –æ–∂–∏–¥–∞–Ω–∏–µ 30-60 —Å–µ–∫—É–Ω–¥

4. **Auto-continue**:
   - –î–ª—è –ø–æ–ª–Ω–æ–π —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ (62 –¥–Ω—è) —Ñ—É–Ω–∫—Ü–∏—è —Å–∞–º–∞ —Å–µ–±—è –≤—ã–∑—ã–≤–∞–µ—Ç —Ü–µ–ø–æ—á–∫–æ–π
   - –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –ø–æ 4 –∫–∞–º–ø–∞–Ω–∏–∏ –∑–∞ —Ä–∞–∑, –∑–∞—Ç–µ–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç

## üÜò –ï—Å–ª–∏ —á—Ç–æ-—Ç–æ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç

1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ Edge Function –≤ Dashboard
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ç–∞–±–ª–∏—Ü—É `ozon_sync_history` –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –æ—à–∏–±–æ–∫
3. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ `marketplace_api_credentials` —Å–æ–¥–µ—Ä–∂–∏—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ Client ID –∏ Secret
4. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è `pg_cron` –∏ `pg_net` –≤–∫–ª—é—á–µ–Ω—ã
5. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ service_role_key –Ω–∞—Å—Ç—Ä–æ–µ–Ω –≤ `app.settings.service_role_key`

## üìû –ü–æ–¥–¥–µ—Ä–∂–∫–∞

–ï—Å–ª–∏ –≤–æ–∑–Ω–∏–∫–ª–∏ –ø—Ä–æ–±–ª–µ–º—ã, –ø—Ä–æ–≤–µ—Ä—å—Ç–µ:
- –õ–æ–≥–∏ –≤ Supabase Dashboard ‚Üí Edge Functions ‚Üí Logs
- –û—à–∏–±–∫–∏ –≤ —Ç–∞–±–ª–∏—Ü–µ `ozon_sync_history`
- –°—Ç–∞—Ç—É—Å –≤ —Ç–∞–±–ª–∏—Ü–µ `marketplace_api_credentials` (–ø–æ–ª–µ `last_error`)
