# Настройка автоматической синхронизации OZON отзывов и вопросов

VERSION: 2026-01-15-v1

## Что было сделано

### 1. Добавлена кнопка "Синхронизировать" в UI
- Расположение: страница "Отзывы и вопросы" → кнопка между "Автогенерация ответов" и "Обновить"
- Функционал: Принудительно загружает новые отзывы и вопросы из OZON API
- Работает для всех активных маркетплейсов с режимом `sync_mode='api'`

### 2. Настроен автоматический cron job
- Запускается каждые 2 часа (как было изначально)
- Синхронизирует отзывы и вопросы для всех активных OZON маркетплейсов
- Исправлен старый cron job с неправильным URL

## Инструкция по применению

### Шаг 1: Применить миграцию базы данных

1. Откройте Supabase Dashboard: https://supabase.com/dashboard/project/bkmicyguzlwampuindff
2. Перейдите в SQL Editor
3. Откройте файл `scripts/apply_cron_migration.sql`
4. Скопируйте весь SQL код
5. Вставьте в SQL Editor и нажмите "Run"

### Шаг 2: Проверить что cron job создан

Запустите в SQL Editor:

```sql
SELECT
  jobname,
  schedule,
  active,
  jobid
FROM cron.job
WHERE jobname = 'sync-ozon-reviews-questions';
```

Должен вернуть:
- jobname: `sync-ozon-reviews-questions`
- schedule: `0 */2 * * *` (каждые 2 часа)
- active: `true`

### Шаг 3: Проверить работу кнопки

1. Откройте приложение
2. Перейдите в "Отзывы и вопросы"
3. Нажмите кнопку "Синхронизировать"
4. Дождитесь завершения (появится уведомление)
5. Проверьте что новые отзывы появились в списке

## Как это работает

### Автоматическая синхронизация (каждые 2 часа)
```
Cron Job → проверяет активные маркетплейсы → вызывает sync-ozon для каждого → загружает отзывы и вопросы
```

### Ручная синхронизация (кнопка)
```
Кнопка "Синхронизировать" → triggerSync() → sync-ozon → загружает отзывы и вопросы → обновляет UI
```

## Требования

Для работы синхронизации маркетплейс должен иметь:
- ✅ `type = 'ozon'`
- ✅ `is_active = true`
- ✅ `sync_mode = 'api'`
- ✅ `service_account_email` заполнен (Client-Id)
- ✅ `api_key_encrypted` заполнен (API-Key)

## Проверка настроек маркетплейса

```sql
SELECT
  id,
  name,
  type,
  is_active,
  sync_mode,
  service_account_email IS NOT NULL as has_client_id,
  api_key_encrypted IS NOT NULL as has_api_key
FROM marketplaces
WHERE type = 'ozon';
```

## Что дальше

После применения миграции:
1. ✅ Автоматическая синхронизация будет работать каждые 2 часа
2. ✅ Вы можете в любой момент нажать "Синхронизировать" для принудительной загрузки
3. ✅ Все новые отзывы и вопросы будут автоматически попадать в систему

## Troubleshooting

### Кнопка не работает
- Проверьте что маркетплейс имеет `sync_mode='api'`
- Проверьте что заполнены `service_account_email` и `api_key_encrypted`
- Откройте DevTools Console и проверьте логи

### Cron job не запускается
- Проверьте что cron job активен: `SELECT * FROM cron.job WHERE jobname = 'sync-ozon-reviews-questions';`
- Проверьте логи cron: может потребоваться доступ к admin panel

### Отзывы не загружаются
- Проверьте что Edge Function `sync-ozon` задеплоена
- Проверьте что API ключи OZON действительны
- Проверьте что товары уже синхронизированы (отзывы привязываются к товарам)
