# üìä Sales Analytics Update - v1.1.0

**–î–∞—Ç–∞:** 2025-12-20
**–í–µ—Ç–∫–∞:** `claude/ozon-performance-zip-support-hN0XE`

---

## üéØ –ß—Ç–æ —Å–¥–µ–ª–∞–Ω–æ

### ‚úÖ –ê–Ω–∞–ª–∏–∑ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

**Excel Import:**
- ‚úÖ –ù–∞—á–∏—Å–ª–µ–Ω–∏—è –û–ó–û–ù (ozon_accruals) - –ø–æ–ª–Ω–æ—Å—Ç—å—é —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω
- ‚úÖ –°—Ç–æ–∏–º–æ—Å—Ç—å —Ä–∞–∑–º–µ—â–µ–Ω–∏—è (storage_costs) - –ø–æ–ª–Ω–æ—Å—Ç—å—é —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω
- ‚úÖ –ü–∞—Ä—Å–∏–Ω–≥ Excel —á–µ—Ä–µ–∑ –±–∏–±–ª–∏–æ—Ç–µ–∫—É xlsx
- ‚úÖ –£–º–Ω–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è –∫–æ–ª–æ–Ω–æ–∫ (–ø–æ–∏—Å–∫ –ø–æ —á–∞—Å—Ç–∏—á–Ω–æ–º—É —Å–æ–≤–ø–∞–¥–µ–Ω–∏—é)
- ‚úÖ –ò—Å—Ç–æ—Ä–∏—è –∏–º–ø–æ—Ä—Ç–∞ –≤ import_logs

**OZON Performance API:**
- ‚úÖ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç (v2.5.2-single-chunk-only)
- ‚úÖ –î–∞–Ω–Ω—ã–µ –≤ —Ç–∞–±–ª–∏—Ü–µ: ozon_performance_daily
- ‚úÖ 1611 –∑–∞–ø–∏—Å–µ–π, 17 –∫–∞–º–ø–∞–Ω–∏–π
- ‚úÖ –ü–µ—Ä–∏–æ–¥—ã —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏: 7 –¥–Ω–µ–π, 62 –¥–Ω—è
- ‚úÖ –ú–µ—Ç—Ä–∏–∫–∏: money_spent, views, clicks, orders, revenue

**Sales Analytics Dashboard:**
- ‚úÖ –ü–æ–ª–Ω–æ—Å—Ç—å—é —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π UI (SalesAnalytics.tsx)
- ‚úÖ –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –¥–≤—É—Ö –ø–µ—Ä–∏–æ–¥–æ–≤
- ‚úÖ –§–æ—Ä–º—É–ª—ã —Ä–∞—Å—á–µ—Ç–æ–≤ (sales-calculations.ts):
  - –í–∞–ª–æ–≤–∫–∞ = –ü—Ä–æ–¥–∞–∂–∏ - (–ó–∞–∫—É–ø–æ—á–Ω–∞—è —Ü–µ–Ω–∞ √ó –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ)
  - –ù–∞—Ü–µ–Ω–∫–∞ % = (–í–∞–ª–æ–≤–∫–∞ / –ü—Ä–æ–¥–∞–∂–∏) √ó 100
  - –ò—Ç–æ–≥–æ–≤–∞—è –º–∞—Ä–∂–∞ = –í–∞–ª–æ–≤–∫–∞ - –ü—Ä–æ–¥–≤–∏–∂–µ–Ω–∏–µ - –†–∞–∑–º–µ—â–µ–Ω–∏–µ - –≠–∫–≤–∞–π—Ä–∏–Ω–≥
  - –ú–∞—Ä–∂–∏–Ω–∞–ª—å–Ω–æ—Å—Ç—å % = (–ú–∞—Ä–∂–∞ / –ü—Ä–æ–¥–∞–∂–∏) √ó 100
- ‚úÖ –ö–∞—Ä—Ç–æ—á–∫–∏ –º–µ—Ç—Ä–∏–∫
- ‚úÖ –î–µ—Ç–∞–ª—å–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ –ø–æ —Ç–æ–≤–∞—Ä–∞–º

### üîß –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ SQL —Ñ—É–Ω–∫—Ü–∏–∏

**–ü—Ä–æ–±–ª–µ–º–∞:**
SQL —Ñ—É–Ω–∫—Ü–∏—è `get_sales_analytics()` –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∞ —Å—Ç–∞—Ä—É—é —Ç–∞–±–ª–∏—Ü—É `promotion_costs`, –∫–æ—Ç–æ—Ä–∞—è –±–æ–ª—å—à–µ –Ω–µ –∑–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è. –¢–µ–ø–µ—Ä—å –¥–∞–Ω–Ω—ã–µ –ø–æ –ø—Ä–æ–¥–≤–∏–∂–µ–Ω–∏—é –ø—Ä–∏—Ö–æ–¥—è—Ç –∏–∑ OZON Performance API –≤ —Ç–∞–±–ª–∏—Ü—É `ozon_performance_daily`.

**–†–µ—à–µ–Ω–∏–µ:**
–°–æ–∑–¥–∞–Ω–∞ –º–∏–≥—Ä–∞—Ü–∏—è `20251220_update_sales_analytics_for_performance_api.sql`, –∫–æ—Ç–æ—Ä–∞—è –æ–±–Ω–æ–≤–ª—è–µ—Ç —Ñ—É–Ω–∫—Ü–∏—é –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –Ω–æ–≤–æ–π —Ç–∞–±–ª–∏—Ü—ã.

**–ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ SQL —Ñ—É–Ω–∫—Ü–∏–∏:**

**–ë—ã–ª–æ:**
```sql
promotion AS (
  SELECT
    pc.offer_id,
    SUM(pc.promotion_cost) as promo_cost
  FROM public.promotion_costs pc  -- ‚ùå –°—Ç–∞—Ä–∞—è —Ç–∞–±–ª–∏—Ü–∞
  WHERE pc.marketplace_id = p_marketplace_id
    AND pc.period_start <= p_end_date
    AND pc.period_end >= p_start_date
    AND pc.offer_id IS NOT NULL
  GROUP BY pc.offer_id
)
```

**–°—Ç–∞–ª–æ:**
```sql
promotion AS (
  SELECT
    opd.offer_id,
    SUM(opd.money_spent) as promo_cost  -- ‚úÖ –ò–∑ Performance API
  FROM public.ozon_performance_daily opd
  WHERE opd.marketplace_id = p_marketplace_id
    AND opd.stat_date BETWEEN p_start_date AND p_end_date
    AND opd.offer_id IS NOT NULL
  GROUP BY opd.offer_id
)
```

---

## üöÄ –î–µ–ø–ª–æ–π –≤ Supabase

### –®–∞–≥ 1: –û—Ç–∫—Ä–æ–π—Ç–µ SQL Editor –≤ Supabase Dashboard

```
https://supabase.com/dashboard/project/nxymhkyvhcfcwjcfcbfy/sql/new
```

### –®–∞–≥ 2: –°–∫–æ–ø–∏—Ä—É–π—Ç–µ –∏ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ –º–∏–≥—Ä–∞—Ü–∏—é

**–§–∞–π–ª –º–∏–≥—Ä–∞—Ü–∏–∏:**
```
/home/user/standalone-spark/supabase/migrations/20251220_update_sales_analytics_for_performance_api.sql
```

**–ò–ª–∏ —Å–∫–æ–ø–∏—Ä—É–π—Ç–µ –∫–æ–¥ –Ω–∞–ø—Ä—è–º—É—é:**

1. –û—Ç–∫—Ä–æ–π—Ç–µ —Ñ–∞–π–ª –≤—ã—à–µ
2. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ **–≤–µ—Å—å –∫–æ–¥**
3. –í—Å—Ç–∞–≤—å—Ç–µ –≤ SQL Editor
4. –ù–∞–∂–º–∏—Ç–µ **Run** –∏–ª–∏ **Ctrl+Enter**

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
```
Success. No rows returned
```

### –®–∞–≥ 3: –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è

–í—ã–ø–æ–ª–Ω–∏—Ç–µ –ø—Ä–æ–≤–µ—Ä–æ—á–Ω—ã–π –∑–∞–ø—Ä–æ—Å:

```sql
-- –ü–æ–ª—É—á–∏—Ç—å –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
SELECT
  p.proname as function_name,
  pg_catalog.obj_description(p.oid, 'pg_proc') as description
FROM pg_catalog.pg_proc p
WHERE p.proname = 'get_sales_analytics';
```

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
- `function_name`: get_sales_analytics
- `description`: "Updated 2025-12-20: Now uses ozon_performance_daily table..."

---

## ‚úÖ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –¢–µ—Å—Ç 1: –ü—Ä–æ–≤–µ—Ä–∫–∞ —á—Ç–æ —Ñ—É–Ω–∫—Ü–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç

```sql
-- –ü–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 7 –¥–Ω–µ–π
SELECT * FROM get_sales_analytics(
  '8d51d87d-a75d-487a-9b8d-29458183f182'::uuid,  -- –í–∞—à marketplace_id
  CURRENT_DATE - INTERVAL '7 days',
  CURRENT_DATE
);
```

**–û–∂–∏–¥–∞–µ—Ç—Å—è:**
- –°–ø–∏—Å–æ–∫ —Ç–æ–≤–∞—Ä–æ–≤ (offer_id)
- total_sales - –ø—Ä–æ–¥–∞–∂–∏ –∏–∑ ozon_accruals
- total_promotion_cost - –∑–∞—Ç—Ä–∞—Ç—ã –∏–∑ ozon_performance_daily ‚úÖ –ù–û–í–û–ï
- total_storage_cost - —Ä–∞–∑–º–µ—â–µ–Ω–∏–µ –∏–∑ storage_costs

### –¢–µ—Å—Ç 2: –û—Ç–∫—Ä—ã—Ç—å Sales Analytics Dashboard

1. –û—Ç–∫—Ä–æ–π—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ ‚Üí **–ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –ü—Ä–æ–¥–∞–∂**
2. –í—ã–±–µ—Ä–∏—Ç–µ –ø–µ—Ä–∏–æ–¥—ã:
   - –ü–µ—Ä–∏–æ–¥ 1: –ø–æ—Å–ª–µ–¥–Ω–∏–µ 30 –¥–Ω–µ–π
   - –ü–µ—Ä–∏–æ–¥ 2: –ø—Ä–µ–¥—ã–¥—É—â–∏–µ 30 –¥–Ω–µ–π
3. –ù–∞–∂–º–∏—Ç–µ **–ü—Ä–∏–º–µ–Ω–∏—Ç—å**

**–û–∂–∏–¥–∞–µ—Ç—Å—è:**
- –ö–∞—Ä—Ç–æ—á–∫–∏ —Å –º–µ—Ç—Ä–∏–∫–∞–º–∏ (–ü—Ä–æ–¥–∞–∂–∏, –í–∞–ª–æ–≤–∫–∞, –ú–∞—Ä–∂–∞, –ú–∞—Ä–∂–∏–Ω–∞–ª—å–Ω–æ—Å—Ç—å %)
- –¢–∞–±–ª–∏—Ü–∞ —Å —Ç–æ–≤–∞—Ä–∞–º–∏ –∏ –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏–µ–π
- –î–∞–Ω–Ω—ã–µ –ø–æ –ø—Ä–æ–¥–≤–∏–∂–µ–Ω–∏—é —Ç–µ–ø–µ—Ä—å –±–µ—Ä—É—Ç—Å—è –∏–∑ OZON Performance API ‚úÖ

### –¢–µ—Å—Ç 3: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞—Å—á–µ—Ç–æ–≤

–í—ã–±–µ—Ä–∏—Ç–µ —Ç–æ–≤–∞—Ä –∏–∑ —Ç–∞–±–ª–∏—Ü—ã –∏ –ø—Ä–æ–≤–µ—Ä—å—Ç–µ —Ñ–æ—Ä–º—É–ª—ã –≤—Ä—É—á–Ω—É—é:

```
–í–∞–ª–æ–≤–∫–∞ = –ü—Ä–æ–¥–∞–∂–∏ - (–ó–∞–∫—É–ø–æ—á–Ω–∞—è —Ü–µ–Ω–∞ √ó –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ)
–ù–∞—Ü–µ–Ω–∫–∞ % = (–í–∞–ª–æ–≤–∫–∞ / –ü—Ä–æ–¥–∞–∂–∏) √ó 100
–ò—Ç–æ–≥–æ–≤–∞—è –º–∞—Ä–∂–∞ = –í–∞–ª–æ–≤–∫–∞ - –ü—Ä–æ–¥–≤–∏–∂–µ–Ω–∏–µ - –†–∞–∑–º–µ—â–µ–Ω–∏–µ - –≠–∫–≤–∞–π—Ä–∏–Ω–≥
–ú–∞—Ä–∂–∏–Ω–∞–ª—å–Ω–æ—Å—Ç—å % = (–ú–∞—Ä–∂–∞ / –ü—Ä–æ–¥–∞–∂–∏) √ó 100
```

---

## üìã –ò—Å—Ç–æ—á–Ω–∏–∫–∏ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∏

| –ü–æ–∫–∞–∑–∞—Ç–µ–ª—å | –¢–∞–±–ª–∏—Ü–∞ | –ü–æ–ª–µ |
|-----------|---------|------|
| **–ü—Ä–æ–¥–∞–∂–∏ (—Ä—É–±)** | ozon_accruals | total_amount WHERE accrual_type = '–î–æ—Å—Ç–∞–≤–∫–∞ –ø–æ–∫—É–ø–∞—Ç–µ–ª—é' |
| **–ü—Ä–æ–¥–∞–∂–∏ (—à—Ç)** | ozon_accruals | quantity |
| **–ó–∞–∫—É–ø–æ—á–Ω–∞—è —Ü–µ–Ω–∞** | product_business_data | purchase_price |
| **–ó–∞—Ç—Ä–∞—Ç—ã –Ω–∞ –ø—Ä–æ–¥–≤–∏–∂–µ–Ω–∏–µ** | ozon_performance_daily | money_spent ‚úÖ –û–ë–ù–û–í–õ–ï–ù–û |
| **–°—Ç–æ–∏–º–æ—Å—Ç—å —Ä–∞–∑–º–µ—â–µ–Ω–∏—è** | storage_costs | storage_cost |
| **–≠–∫–≤–∞–π—Ä–∏–Ω–≥** | ozon_accruals | total_amount WHERE accrual_type = '–û–ø–ª–∞—Ç–∞ —ç–∫–≤–∞–π—Ä–∏–Ω–≥–∞' |

---

## üîÑ –ü–æ—Ç–æ–∫ –¥–∞–Ω–Ω—ã—Ö

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ 1. –ò–ú–ü–û–†–¢ –î–ê–ù–ù–´–• (ImportData.tsx)                      ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ  ‚Üì Excel —Ñ–∞–π–ª—ã                                          ‚îÇ
‚îÇ  ‚Ä¢ –ù–∞—á–∏—Å–ª–µ–Ω–∏—è –û–ó–û–ù ‚Üí ozon_accruals                     ‚îÇ
‚îÇ  ‚Ä¢ –°—Ç–æ–∏–º–æ—Å—Ç—å —Ä–∞–∑–º–µ—â–µ–Ω–∏—è ‚Üí storage_costs                ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                       ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ 2. –°–ò–ù–•–†–û–ù–ò–ó–ê–¶–ò–Ø PERFORMANCE API (sync-ozon-performance)‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ  ‚Üì OZON Performance API (ZIP + CSV)                    ‚îÇ
‚îÇ  ‚Ä¢ –ó–∞—Ç—Ä–∞—Ç—ã –Ω–∞ —Ä–µ–∫–ª–∞–º—É ‚Üí ozon_performance_daily         ‚îÇ
‚îÇ  ‚Ä¢ –ú–µ—Ç—Ä–∏–∫–∏: money_spent, views, clicks, orders         ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                       ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ 3. –ë–ò–ó–ù–ï–°-–î–ê–ù–ù–´–ï (ProductSettings.tsx)                 ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ  ‚Üì –†—É—á–Ω–æ–π –≤–≤–æ–¥ / Excel –∏–º–ø–æ—Ä—Ç                          ‚îÇ
‚îÇ  ‚Ä¢ –ó–∞–∫—É–ø–æ—á–Ω–∞—è —Ü–µ–Ω–∞ ‚Üí product_business_data             ‚îÇ
‚îÇ  ‚Ä¢ –ü–æ—Å—Ç–∞–≤—â–∏–∫, –∫–∞—Ç–µ–≥–æ—Ä–∏—è, –≤–∏–¥, –ø–æ–¥–≤–∏–¥                   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                       ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ 4. SQL –§–£–ù–ö–¶–ò–Ø get_sales_analytics()                   ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ  ‚Üì –û–±—ä–µ–¥–∏–Ω—è–µ—Ç –¥–∞–Ω–Ω—ã–µ –∏–∑ –≤—Å–µ—Ö —Ç–∞–±–ª–∏—Ü                   ‚îÇ
‚îÇ  ‚Ä¢ FULL OUTER JOIN: sales + promotion + storage        ‚îÇ
‚îÇ  ‚Ä¢ –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç: offer_id, total_sales, costs            ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                       ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ 5. FRONTEND (useSalesAnalytics + sales-calculations)   ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ  ‚Üì –ó–∞–≥—Ä—É–∂–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ —á–µ—Ä–µ–∑ RPC                          ‚îÇ
‚îÇ  ‚Ä¢ –î–æ–±–∞–≤–ª—è–µ—Ç product names, suppliers                  ‚îÇ
‚îÇ  ‚Ä¢ –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç –º–µ—Ç—Ä–∏–∫–∏: –≤–∞–ª–æ–≤–∫–∞, –º–∞—Ä–∂–∞, –Ω–∞—Ü–µ–Ω–∫–∞      ‚îÇ
‚îÇ  ‚Ä¢ –û—Ç–æ–±—Ä–∞–∂–∞–µ—Ç –≤ UI (SalesAnalytics.tsx)               ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## ‚ö†Ô∏è –í–∞–∂–Ω—ã–µ –∑–∞–º–µ—á–∞–Ω–∏—è

### 1. –î–∞–Ω–Ω—ã–µ –ø–æ –ø—Ä–æ–¥–≤–∏–∂–µ–Ω–∏—é —Ç–µ–ø–µ—Ä—å –±–æ–ª–µ–µ –¥–µ—Ç–∞–ª—å–Ω—ã–µ

**–†–∞–Ω—å—à–µ (promotion_costs):**
- –î–∞–Ω–Ω—ã–µ –≤—Ä—É—á–Ω—É—é –∏–ª–∏ –∏–∑ Excel
- –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –ø–æ –Ω–µ–¥–µ–ª—è–º/–º–µ—Å—è—Ü–∞–º

**–¢–µ–ø–µ—Ä—å (ozon_performance_daily):**
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∏–∑ OZON Performance API
- –†–∞–∑–±–∏–≤–∫–∞ –ø–æ –¥–Ω—è–º ‚úÖ
- –†–∞–∑–±–∏–≤–∫–∞ –ø–æ –∫–∞–º–ø–∞–Ω–∏—è–º ‚úÖ
- –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏: views, clicks, orders, CTR, CPC

### 2. –¢—Ä–µ–±—É–µ—Ç—Å—è offer_id

SQL —Ñ—É–Ω–∫—Ü–∏—è —Ç—Ä–µ–±—É–µ—Ç —á—Ç–æ–±—ã –≤ `ozon_performance_daily` –±—ã–ª –∑–∞–ø–æ–ª–Ω–µ–Ω `offer_id`.

**–ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç:**
1. OZON Performance API –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ç–æ–ª—å–∫–æ SKU
2. –¢—Ä–∏–≥–≥–µ—Ä `trigger_fill_offer_id_performance` –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏—â–µ—Ç offer_id —á–µ—Ä–µ–∑ —Ñ—É–Ω–∫—Ü–∏—é `find_offer_id_by_sku()`
3. –ï—Å–ª–∏ —Ç–æ–≤–∞—Ä –Ω–∞–π–¥–µ–Ω –≤ `products` - offer_id –∑–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è
4. –ï—Å–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω - offer_id –æ—Å—Ç–∞–µ—Ç—Å—è NULL (–¥–∞–Ω–Ω—ã–µ –Ω–µ –ø–æ–ø–∞–¥—É—Ç –≤ –∞–Ω–∞–ª–∏—Ç–∏–∫—É)

**–†–µ—à–µ–Ω–∏–µ:** –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ —Ç–∞–±–ª–∏—Ü–∞ `products` —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–∞ —Å OZON API (—á–µ—Ä–µ–∑ sync-products).

### 3. –ó–∞–∫—É–ø–æ—á–Ω–∞—è —Ü–µ–Ω–∞ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–∞

–î–ª—è —Ä–∞—Å—á–µ—Ç–∞ –≤–∞–ª–æ–≤–∫–∏ –∏ –º–∞—Ä–∂–∏ –Ω—É–∂–Ω–∞ –∑–∞–∫—É–ø–æ—á–Ω–∞—è —Ü–µ–Ω–∞ –≤ `product_business_data`.

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
```sql
SELECT
  COUNT(*) as total_products,
  COUNT(purchase_price) as with_price,
  COUNT(*) - COUNT(purchase_price) as without_price
FROM product_business_data
WHERE marketplace_id = '–≤–∞—à-marketplace-id';
```

**–ï—Å–ª–∏ without_price > 0:**
- –ó–∞–ø–æ–ª–Ω–∏—Ç–µ –∑–∞–∫—É–ø–æ—á–Ω—ã–µ —Ü–µ–Ω—ã —á–µ—Ä–µ–∑ ProductSettings
- –ò–ª–∏ –∏–º–ø–æ—Ä—Ç–∏—Ä—É–π—Ç–µ –∏–∑ Excel

---

## üìù –ö–æ–º–º–∏—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π

```bash
git add supabase/migrations/20251220_update_sales_analytics_for_performance_api.sql
git add DEPLOY_SALES_ANALYTICS_UPDATE.md
git commit -m "Update get_sales_analytics() to use ozon_performance_daily table

- Replace old promotion_costs table with ozon_performance_daily
- Now aggregates money_spent from Performance API sync
- More accurate promotion cost data (daily breakdown by campaigns)
- Add deployment guide with testing instructions
"
git push -u origin claude/ozon-performance-zip-support-hN0XE
```

---

## üéØ –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

### 1. –ü–æ—Å–ª–µ –¥–µ–ø–ª–æ—è SQL –º–∏–≥—Ä–∞—Ü–∏–∏:

- [ ] –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å SQL —Ñ—É–Ω–∫—Ü–∏—é –Ω–∞–ø—Ä—è–º—É—é
- [ ] –û—Ç–∫—Ä—ã—Ç—å Sales Analytics Dashboard
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –¥–∞–Ω–Ω—ã–µ –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–∞—Å—á–µ—Ç—ã —Ñ–æ—Ä–º—É–ª

### 2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–∞–Ω–Ω—ã–µ:

- [ ] –£–±–µ–¥–∏—Ç—å—Å—è —á—Ç–æ –≤ ozon_accruals –µ—Å—Ç—å –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è
- [ ] –£–±–µ–¥–∏—Ç—å—Å—è —á—Ç–æ –≤ storage_costs –µ—Å—Ç—å —Å—Ç–æ–∏–º–æ—Å—Ç—å —Ä–∞–∑–º–µ—â–µ–Ω–∏—è
- [ ] –£–±–µ–¥–∏—Ç—å—Å—è —á—Ç–æ –≤ ozon_performance_daily –µ—Å—Ç—å –∑–∞—Ç—Ä–∞—Ç—ã –Ω–∞ —Ä–µ–∫–ª–∞–º—É
- [ ] –£–±–µ–¥–∏—Ç—å—Å—è —á—Ç–æ –≤ product_business_data –∑–∞–ø–æ–ª–Ω–µ–Ω—ã purchase_price

### 3. –ó–∞–ø–æ–ª–Ω–∏—Ç—å –Ω–µ–¥–æ—Å—Ç–∞—é—â–∏–µ –¥–∞–Ω–Ω—ã–µ:

- [ ] –ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è –û–ó–û–ù (–µ—Å–ª–∏ –Ω–µ—Ç)
- [ ] –ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å —Å—Ç–æ–∏–º–æ—Å—Ç—å —Ä–∞–∑–º–µ—â–µ–Ω–∏—è (–µ—Å–ª–∏ –Ω–µ—Ç)
- [ ] –ó–∞–ø—É—Å—Ç–∏—Ç—å —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é Performance API –∑–∞ 62 –¥–Ω—è
- [ ] –ó–∞–ø–æ–ª–Ω–∏—Ç—å –∑–∞–∫—É–ø–æ—á–Ω—ã–µ —Ü–µ–Ω—ã —á–µ—Ä–µ–∑ ProductSettings

---

## ‚úÖ –ü—Ä–æ–≤–µ—Ä–æ—á–Ω—ã–π —á–µ–∫–ª–∏—Å—Ç

- [ ] SQL –º–∏–≥—Ä–∞—Ü–∏—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∞ –≤ Supabase
- [ ] –§—É–Ω–∫—Ü–∏—è get_sales_analytics –æ–±–Ω–æ–≤–ª–µ–Ω–∞ (–ø—Ä–æ–≤–µ—Ä–∏—Ç—å —á–µ—Ä–µ–∑ SQL)
- [ ] Sales Analytics Dashboard –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è –±–µ–∑ –æ—à–∏–±–æ–∫
- [ ] –í–∏–¥–Ω—ã –¥–∞–Ω–Ω—ã–µ –ø–æ –ø—Ä–æ–¥–∞–∂–∞–º
- [ ] –í–∏–¥–Ω—ã –¥–∞–Ω–Ω—ã–µ –ø–æ –ø—Ä–æ–¥–≤–∏–∂–µ–Ω–∏—é (–∏–∑ ozon_performance_daily)
- [ ] –í–∏–¥–Ω—ã –¥–∞–Ω–Ω—ã–µ –ø–æ —Ä–∞–∑–º–µ—â–µ–Ω–∏—é
- [ ] –§–æ—Ä–º—É–ª—ã —Ä–∞—Å—á–µ—Ç–æ–≤ —Ä–∞–±–æ—Ç–∞—é—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- [ ] –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –¥–≤—É—Ö –ø–µ—Ä–∏–æ–¥–æ–≤ —Ä–∞–±–æ—Ç–∞–µ—Ç
- [ ] –¢–∞–±–ª–∏—Ü–∞ –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏–∏ –∑–∞–ø–æ–ª–Ω–µ–Ω–∞

---

## üìö –ü–æ–ª–µ–∑–Ω—ã–µ —Å—Å—ã–ª–∫–∏

**–ö–æ–¥:**
- Migration: `/home/user/standalone-spark/supabase/migrations/20251220_update_sales_analytics_for_performance_api.sql`
- Frontend: `/home/user/standalone-spark/src/pages/SalesAnalytics.tsx`
- Hook: `/home/user/standalone-spark/src/hooks/useSalesAnalytics.ts`
- Calculations: `/home/user/standalone-spark/src/lib/sales-calculations.ts`
- Import: `/home/user/standalone-spark/src/pages/ImportData.tsx`

**–ü–ª–∞–Ω:**
- Sales Analytics Plan: `/home/user/standalone-spark/docs/SALES_ANALYTICS_PLAN.md`

**–¢–∞–±–ª–∏—Ü—ã:**
- ozon_accruals: `/home/user/standalone-spark/supabase/migrations/20251206120002_create_ozon_accruals_table.sql`
- storage_costs: `/home/user/standalone-spark/supabase/migrations/20251206120003_create_storage_costs_table.sql`
- ozon_performance_daily: `/home/user/standalone-spark/supabase/migrations/20251209000000_create_ozon_performance_daily_table.sql`
- Helper functions: `/home/user/standalone-spark/supabase/migrations/20251206120005_create_helper_functions.sql`

---

**–í–µ—Ä—Å–∏—è:** 1.1.0
**–î–∞—Ç–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è:** 2025-12-20
**–°—Ç–∞—Ç—É—Å:** –ì–æ—Ç–æ–≤–æ –∫ –¥–µ–ø–ª–æ—é ‚úÖ
