# sync-ozon-performance: основные проблемы и пути решения

Ниже собраны наблюдения по функции Supabase `supabase/functions/sync-ozon-performance/index.ts`, из‑за которых чаще всего возникают ошибки и неожиданные таймауты при запуске синхронизации OZON Performance.

## 1. Тайм‑аут Supabase Edge Functions
* Polling отчетов выполняется последовательно по каждому chunk, с задержкой 5 секунд перед стартом и до 10 попыток с интервалом 3 секунды (`pollReportStatus`). 
* Даже для одного UUID это ~35 секунд ожидания; при 4 чанках общее время легко превышает лимит функции (40 секунд), что приводит к обрыву и ошибке `Report polling failed` или `timeout`.

**Что сделать**
* Запускать polling параллельно для всех UUID (Promise.all) и уменьшить интервалы/число попыток, либо отдавать управление фоновой задаче (webhook / cron + статус в таблице).
* Для ручного запуска отдавать пользователю `sync_id` и статус «в обработке», а не держать соединение до завершения.

## 2. Потеря ключевых идентификаторов из отчета
* В CSV‑обработке используется текущая дата (`new Date().toISOString().split('T')[0]`) и пустой `campaign_id` — реальные дата и ID кампании из отчета не вытягиваются.
* Upsert идёт по ключу `marketplace_id, stat_date, sku, campaign_id`. Из‑за пустого `campaign_id` записи агрегируются в одну строку или конфликтуют, а синхронизация «проходит», но данные некорректны.

**Что сделать**
* Парсить дату и идентификаторы кампаний из метаданных отчёта: в JSON или в первых строках CSV (в комментарии и заголовке). Сохранять реальные значения в `stat_date` и `campaign_id`.
* Добавить валидацию: если `campaign_id`/дата не распознаны, помечать sync как `failed` с подробной ошибкой.

## 3. Неполная выборка кампаний
* Кампании режутся на чанки по 10, но обрабатываются только первые 4 чанка (максимум 40 кампаний) из‑за ограничений времени. Если у аккаунта больше кампаний, остальные игнорируются без явного уведомления пользователю, только console.error.

**Что сделать**
* Явно возвращать в ответе предупреждение и счётчики «всего/обработано», либо реализовать пагинацию синхронизации (продолжать с того места, где остановились).
* Для фонового режима – писать недообработанные кампании в `metadata` и запускать продолжение отдельным job.

## 4. Ограниченная диагностика ошибок токена
* Проверка редиректа при получении токена есть, но текст ошибки OZON не сохраняется в `ozon_sync_history`, поэтому в UI остаётся только «Failed to obtain access token» без деталей.

**Что сделать**
* Сохранять `details` ответа токена в `error_message` записи синхронизации и возвращать их в теле ответа, чтобы UI мог показать пользователю причину (неверный client_id/secret, блокировка и т.д.).

## Итог
Основные сбои вызваны превышением лимита времени функции и потерей идентификаторов из отчёта, из‑за чего запрос завершается ошибкой или сохраняются неконсистентные данные. Первое лечится асинхронной обработкой/параллелизацией polling, второе — корректным парсингом даты и `campaign_id` и явной валидацией данных.
