<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>–¢–µ—Å—Ç OZON Sync 18-19.12</title>
    <style>
        body { font-family: Arial; padding: 20px; max-width: 800px; margin: 0 auto; }
        button { padding: 10px 20px; font-size: 16px; cursor: pointer; margin: 10px 0; }
        .log { background: #f5f5f5; padding: 10px; margin: 10px 0; min-height: 300px; max-height: 500px; overflow-y: auto; font-family: monospace; font-size: 12px; }
        .success { color: green; }
        .error { color: red; }
    </style>
</head>
<body>
    <h1>OZON Performance Sync - –¢–µ—Å—Ç 18-19.12.2025</h1>
    <p><b>SKU –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏:</b> 3107627916</p>
    <p><b>–û–∂–∏–¥–∞–µ—Ç—Å—è:</b> 10 –∑–∞–∫–∞–∑–æ–≤ + 1 –∑–∞–∫–∞–∑ –º–æ–¥–µ–ª–∏ = 11 –≤—Å–µ–≥–æ</p>

    <button onclick="runSync()" id="syncBtn">üöÄ –ó–∞–ø—É—Å—Ç–∏—Ç—å —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é –∑–∞ 18-19.12</button>
    <button onclick="checkData()" id="checkBtn">üìä –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –≤ –ë–î</button>
    <button onclick="clearLog()">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å –ª–æ–≥</button>

    <div class="log" id="log"></div>

    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm'

        const SUPABASE_URL = 'https://bkmicyguzlwampuindff.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJrbWljeWd1emx3YW1wdWluZGZmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ2OTUwMjMsImV4cCI6MjA4MDI3MTAyM30.v8BlZ_k8DxdSmh5Ao1da7GHurSshE1cBsMxdfQCp9PQ';

        const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        function log(msg, type = '') {
            const el = document.getElementById('log');
            const time = new Date().toLocaleTimeString();
            const className = type === 'success' ? 'success' : type === 'error' ? 'error' : '';
            el.innerHTML += `<div class="${className}">[${time}] ${msg}</div>`;
            el.scrollTop = el.scrollHeight;
        }

        window.clearLog = () => {
            document.getElementById('log').innerHTML = '';
        };

        window.runSync = async () => {
            const btn = document.getElementById('syncBtn');
            btn.disabled = true;
            log('üîÑ –ù–∞—á–∏–Ω–∞–µ–º —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é...');

            try {
                // –ü–æ–ª—É—á–∞–µ–º marketplace_id
                log('üì• –ü–æ–ª—É—á–∞–µ–º ID –º–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å–∞ OZON...');
                const { data: mp, error: mpError } = await supabase
                    .from('marketplaces')
                    .select('id, name')
                    .eq('type', 'OZON')
                    .single();

                if (mpError) throw new Error('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –º–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å–∞: ' + mpError.message);
                if (!mp) throw new Error('OZON –º–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –ë–î');

                log(`‚úÖ –ú–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å –Ω–∞–π–¥–µ–Ω: ${mp.name} (${mp.id})`, 'success');

                // –ó–∞–ø—É—Å–∫–∞–µ–º —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é
                log('üöÄ –ó–∞–ø—É—Å–∫–∞–µ–º Edge Function sync-ozon-performance...');
                log('üìÖ –ü–µ—Ä–∏–æ–¥: 2025-12-18 ‚Üí 2025-12-19');

                const { data, error } = await supabase.functions.invoke('sync-ozon-performance', {
                    body: {
                        marketplace_id: mp.id,
                        start_date: '2025-12-18',
                        end_date: '2025-12-19',
                    }
                });

                if (error) throw new Error('–û—à–∏–±–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏: ' + error.message);

                log('‚úÖ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞!', 'success');
                log('üì¶ –†–µ–∑—É–ª—å—Ç–∞—Ç: ' + JSON.stringify(data, null, 2), 'success');

                if (data.version) {
                    log(`üìå –í–µ—Ä—Å–∏—è Edge Function: ${data.version}`, 'success');
                }

                log('');
                log('üëâ –¢–µ–ø–µ—Ä—å –Ω–∞–∂–º–∏ "–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –≤ –ë–î" —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç');

            } catch (err) {
                log('‚ùå –û–®–ò–ë–ö–ê: ' + err.message, 'error');
                console.error(err);
            } finally {
                btn.disabled = false;
            }
        };

        window.checkData = async () => {
            const btn = document.getElementById('checkBtn');
            btn.disabled = true;
            log('');
            log('üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è SKU 3107627916...');

            try {
                const { data, error } = await supabase
                    .from('ozon_performance_daily')
                    .select('*')
                    .eq('sku', '3107627916')
                    .gte('stat_date', '2025-12-18')
                    .lte('stat_date', '2025-12-19')
                    .order('stat_date')
                    .order('campaign_name');

                if (error) throw new Error('–û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞: ' + error.message);

                if (!data || data.length === 0) {
                    log('‚ö†Ô∏è –î–∞–Ω–Ω—ã–µ –ù–ï –ù–ê–ô–î–ï–ù–´ –¥–ª—è –ø–µ—Ä–∏–æ–¥–∞ 18-19.12!', 'error');
                    log('–í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã:');
                    log('  1. –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –Ω–µ –≤—ã–ø–æ–ª–Ω—è–ª–∞—Å—å');
                    log('  2. OZON –Ω–µ –≤–µ—Ä–Ω—É–ª –¥–∞–Ω–Ω—ã–µ –∑–∞ —ç—Ç–æ—Ç –ø–µ—Ä–∏–æ–¥');
                    log('  3. SKU 3107627916 –Ω–µ –±—ã–ª –∞–∫—Ç–∏–≤–µ–Ω –≤ —ç—Ç–∏ –¥–Ω–∏');
                    return;
                }

                log(`‚úÖ –ù–∞–π–¥–µ–Ω–æ ${data.length} –∑–∞–ø–∏—Å–µ–π`, 'success');
                log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');

                let totalOrders = 0;
                let totalOrdersModel = 0;
                let totalRevenue = 0;

                data.forEach(row => {
                    totalOrders += row.orders || 0;
                    totalOrdersModel += row.orders_model || 0;
                    totalRevenue += parseFloat(row.revenue || 0);

                    log(`üìÖ ${row.stat_date} | ${row.campaign_name}`);
                    log(`   –ó–∞–∫–∞–∑—ã: ${row.orders}, –ó–∞–∫–∞–∑—ã –º–æ–¥–µ–ª–∏: ${row.orders_model}, –í—ã—Ä—É—á–∫–∞: ${row.revenue}‚ÇΩ`);
                    log(`   –ò–º–ø–æ—Ä—Ç: ${row.imported_at}`);
                    log('');
                });

                log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');
                log('üìä –ò–¢–û–ì–û:', 'success');
                log(`   –ó–∞–∫–∞–∑—ã: ${totalOrders}`, 'success');
                log(`   –ó–∞–∫–∞–∑—ã –º–æ–¥–µ–ª–∏: ${totalOrdersModel}`, 'success');
                log(`   –í–°–ï–ì–û –∑–∞–∫–∞–∑–æ–≤: ${totalOrders + totalOrdersModel}`, 'success');
                log(`   –í—ã—Ä—É—á–∫–∞: ${totalRevenue.toFixed(2)}‚ÇΩ`, 'success');
                log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');

                log('üéØ –û–ñ–ò–î–ê–õ–û–°–¨:', 'success');
                log('   –ó–∞–∫–∞–∑—ã: 10');
                log('   –ó–∞–∫–∞–∑—ã –º–æ–¥–µ–ª–∏: 1');
                log('   –í–°–ï–ì–û: 11');
                log('   –í—ã—Ä—É—á–∫–∞: ~15948‚ÇΩ (14750 + 1198)');
                log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');

                const ordersOk = totalOrders === 10;
                const modelsOk = totalOrdersModel === 1;
                const totalOk = (totalOrders + totalOrdersModel) === 11;

                if (ordersOk && modelsOk && totalOk) {
                    log('‚úÖ‚úÖ‚úÖ –í–°–ï –ü–†–ê–í–ò–õ–¨–ù–û! –î–∞–Ω–Ω—ã–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç —Å –æ–∂–∏–¥–∞–µ–º—ã–º–∏!', 'success');
                } else {
                    log('‚ö†Ô∏è –ù–ï–°–û–û–¢–í–ï–¢–°–¢–í–ò–ï!', 'error');
                    if (!ordersOk) log(`  - –ó–∞–∫–∞–∑—ã: –æ–∂–∏–¥–∞–ª–æ—Å—å 10, –ø–æ–ª—É—á–µ–Ω–æ ${totalOrders}`, 'error');
                    if (!modelsOk) log(`  - –ó–∞–∫–∞–∑—ã –º–æ–¥–µ–ª–∏: –æ–∂–∏–¥–∞–ª–æ—Å—å 1, –ø–æ–ª—É—á–µ–Ω–æ ${totalOrdersModel}`, 'error');
                    if (!totalOk) log(`  - –í–°–ï–ì–û: –æ–∂–∏–¥–∞–ª–æ—Å—å 11, –ø–æ–ª—É—á–µ–Ω–æ ${totalOrders + totalOrdersModel}`, 'error');
                }

            } catch (err) {
                log('‚ùå –û–®–ò–ë–ö–ê: ' + err.message, 'error');
                console.error(err);
            } finally {
                btn.disabled = false;
            }
        };

        log('‚úÖ –°—Ç—Ä–∞–Ω–∏—Ü–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞ –∏ –≥–æ—Ç–æ–≤–∞ –∫ —Ä–∞–±–æ—Ç–µ!', 'success');
        log('üëâ –ù–∞–∂–º–∏ "–ó–∞–ø—É—Å—Ç–∏—Ç—å —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é" –¥–ª—è –Ω–∞—á–∞–ª–∞');
        log('');
    </script>
</body>
</html>
