# üßπ –û—á–∏—Å—Ç–∫–∞ –ª–æ–≥–æ–≤ OZON Sync

## –ü—Ä–æ–±–ª–µ–º–∞

–¢–∞–±–ª–∏—Ü–∞ `ozon_sync` —Å–æ–¥–µ—Ä–∂–∏—Ç —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –ª–æ–≥–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ —Å OZON API –∏ –∑–∞–Ω–∏–º–∞–µ—Ç **~5 GB** –º–µ—Å—Ç–∞ –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö. –≠—Ç–∏ –ª–æ–≥–∏ –Ω—É–∂–Ω—ã —Ç–æ–ª—å–∫–æ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏ –∏ –∏—Ö –º–æ–∂–Ω–æ –±–µ–∑–æ–ø–∞—Å–Ω–æ —É–¥–∞–ª—è—Ç—å.

## –†–µ—à–µ–Ω–∏–µ

–ù–∞—Å—Ç—Ä–æ–µ–Ω–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞ –ª–æ–≥–æ–≤ —Å—Ç–∞—Ä—à–µ **7 –¥–Ω–µ–π**:
- ‚úÖ –ë–∞—Ç—á-—É–¥–∞–ª–µ–Ω–∏–µ (–±–µ–∑ timeout)
- ‚úÖ –ï–∂–µ–¥–Ω–µ–≤–Ω—ã–π cron job (–∫–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ 03:00 UTC)
- ‚úÖ –ë–µ–∑–æ–ø–∞—Å–Ω–æ –¥–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞

---

## üìã –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

### –®–∞–≥ 1: –û–¥–Ω–æ—Ä–∞–∑–æ–≤–∞—è –æ—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –ª–æ–≥–æ–≤ (–°–ï–ô–ß–ê–°)

–ó–∞–ø—É—Å—Ç–∏—Ç–µ –≤ Supabase SQL Editor:
```
https://supabase.com/dashboard/project/bkmicyguzlwampuindff/sql/new
```

**–°–∫–æ–ø–∏—Ä—É–π—Ç–µ –∏ –∑–∞–ø—É—Å—Ç–∏—Ç–µ —Ñ–∞–π–ª:**
```
CLEANUP_OZON_SYNC_LOGS.sql
```

**–ß—Ç–æ –ø—Ä–æ–∏–∑–æ–π–¥—ë—Ç:**
- üóëÔ∏è –£–¥–∞–ª–∏—Ç –ª–æ–≥–∏ —Å—Ç–∞—Ä—à–µ 7 –¥–Ω–µ–π –±–∞—Ç—á–∞–º–∏ (–ø–æ 10k –∑–∞–ø–∏—Å–µ–π)
- üìä –ü–æ–∫–∞–∂–µ—Ç –ø—Ä–æ–≥—Ä–µ—Å—Å –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
- ‚è±Ô∏è –ó–∞–π–º—ë—Ç ~5-10 –º–∏–Ω—É—Ç
- üíæ –û—Å–≤–æ–±–æ–¥–∏—Ç ~4-5 GB –º–µ—Å—Ç–∞

**–ü—Ä–∏–º–µ—Ä –≤—ã–≤–æ–¥–∞:**
```
üìä –°–¢–ê–¢–ò–°–¢–ò–ö–ê –ü–ï–†–ï–î –û–ß–ò–°–¢–ö–û–ô:
   –í—Å–µ–≥–æ –ª–æ–≥–æ–≤: 2757664
   –õ–æ–≥–æ–≤ —Å—Ç–∞—Ä—à–µ 7 –¥–Ω–µ–π: 2500000
   –õ–æ–≥–æ–≤ –æ—Å—Ç–∞–Ω–µ—Ç—Å—è: 257664

üöÄ –ù–ê–ß–ò–ù–ê–ï–ú –ë–ê–¢–ß-–£–î–ê–õ–ï–ù–ò–ï...
   –ë–∞—Ç—á 10: —É–¥–∞–ª–µ–Ω–æ 10000 –∑–∞–ø–∏—Å–µ–π | –í—Å–µ–≥–æ: 100000 | –í—Ä–µ–º—è: 5.2s
   –ë–∞—Ç—á 20: —É–¥–∞–ª–µ–Ω–æ 10000 –∑–∞–ø–∏—Å–µ–π | –í—Å–µ–≥–æ: 200000 | –í—Ä–µ–º—è: 10.8s
   ...

‚úÖ –£–î–ê–õ–ï–ù–ò–ï –ó–ê–í–ï–†–®–ï–ù–û!
   –£–¥–∞–ª–µ–Ω–æ –∑–∞–ø–∏—Å–µ–π: 2500000
   –í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è: 312.45 —Å–µ–∫
```

---

### –®–∞–≥ 2: –ü—Ä–∏–º–µ–Ω–∏—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫—É—é –æ—á–∏—Å—Ç–∫—É (–û–î–ò–ù –†–ê–ó)

–ó–∞–ø—É—Å—Ç–∏—Ç–µ –º–∏–≥—Ä–∞—Ü–∏—é –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –µ–∂–µ–¥–Ω–µ–≤–Ω–æ–π –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –æ—á–∏—Å—Ç–∫–∏:

```
supabase/migrations/20260119_cleanup_ozon_sync_logs.sql
```

**–ß—Ç–æ –ø—Ä–æ–∏–∑–æ–π–¥—ë—Ç:**
- ü§ñ –°–æ–∑–¥–∞—Å—Ç—Å—è —Ñ—É–Ω–∫—Ü–∏—è `cleanup_ozon_sync_logs()`
- ‚è∞ –ù–∞—Å—Ç—Ä–æ–∏—Ç—Å—è cron job –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –∫–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ 03:00 UTC
- üîÑ –õ–æ–≥–∏ –±—É–¥—É—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É–¥–∞–ª—è—Ç—å—Å—è –∫–∞–∂–¥—ã–π –¥–µ–Ω—å

**–ü—Ä–æ–≤–µ—Ä–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏:**
```sql
-- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ cron job —Å–æ–∑–¥–∞–Ω
SELECT jobname, schedule, active
FROM cron.job
WHERE jobname = 'cleanup-ozon-sync-logs-daily';
```

–î–æ–ª–∂–µ–Ω –ø–æ–∫–∞–∑–∞—Ç—å:
```
jobname                        | schedule    | active
-------------------------------|-------------|--------
cleanup-ozon-sync-logs-daily  | 0 3 * * *   | t
```

---

## üîß –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ

### –†—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫ –æ—á–∏—Å—Ç–∫–∏

–ï—Å–ª–∏ –Ω—É–∂–Ω–æ –∑–∞–ø—É—Å—Ç–∏—Ç—å –æ—á–∏—Å—Ç–∫—É –≤—Ä—É—á–Ω—É—é:

```sql
SELECT * FROM public.cleanup_ozon_sync_logs();
```

–†–µ–∑—É–ª—å—Ç–∞—Ç:
```
deleted_count | total_time_ms | batches_processed
--------------|---------------|------------------
150000        | 75234         | 15
```

### –û—Ç–∫–ª—é—á–∏—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫—É—é –æ—á–∏—Å—Ç–∫—É

–ï—Å–ª–∏ –Ω—É–∂–Ω–æ –≤—Ä–µ–º–µ–Ω–Ω–æ –æ—Ç–∫–ª—é—á–∏—Ç—å:

```sql
-- –û—Ç–∫–ª—é—á–∏—Ç—å (–Ω–µ —É–¥–∞–ª—è—è)
SELECT cron.alter_job(
  (SELECT jobid FROM cron.job WHERE jobname = 'cleanup-ozon-sync-logs-daily'),
  enabled := false
);

-- –í–∫–ª—é—á–∏—Ç—å –æ–±—Ä–∞—Ç–Ω–æ
SELECT cron.alter_job(
  (SELECT jobid FROM cron.job WHERE jobname = 'cleanup-ozon-sync-logs-daily'),
  enabled := true
);
```

### –£–¥–∞–ª–∏—Ç—å cron job –ø–æ–ª–Ω–æ—Å—Ç—å—é

```sql
SELECT cron.unschedule('cleanup-ozon-sync-logs-daily');
```

---

## üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–∫–æ–ª—å–∫–æ –ª–æ–≥–æ–≤ —Å–µ–π—á–∞—Å

```sql
SELECT
  COUNT(*) as total_logs,
  COUNT(*) FILTER (WHERE created_at < NOW() - INTERVAL '7 days') as old_logs,
  pg_size_pretty(pg_relation_size('public.ozon_sync')) as table_size
FROM public.ozon_sync;
```

### –ò—Å—Ç–æ—Ä–∏—è –∑–∞–ø—É—Å–∫–æ–≤ cron job

```sql
SELECT
  runid,
  job_pid,
  database,
  username,
  command,
  status,
  return_message,
  start_time,
  end_time
FROM cron.job_run_details
WHERE jobname = 'cleanup-ozon-sync-logs-daily'
ORDER BY start_time DESC
LIMIT 10;
```

---

## ‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏

### –ò–∑–º–µ–Ω–∏—Ç—å –ø–µ—Ä–∏–æ–¥ —Ö—Ä–∞–Ω–µ–Ω–∏—è –ª–æ–≥–æ–≤

–ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –ª–æ–≥–∏ —É–¥–∞–ª—è—é—Ç—Å—è —á–µ—Ä–µ–∑ **7 –¥–Ω–µ–π**. –ß—Ç–æ–±—ã –∏–∑–º–µ–Ω–∏—Ç—å:

```sql
-- –°–æ–∑–¥–∞—ë–º –Ω–æ–≤—É—é –≤–µ—Ä—Å–∏—é —Ñ—É–Ω–∫—Ü–∏–∏ —Å –¥—Ä—É–≥–∏–º –ø–µ—Ä–∏–æ–¥–æ–º (–Ω–∞–ø—Ä–∏–º–µ—Ä, 14 –¥–Ω–µ–π)
CREATE OR REPLACE FUNCTION public.cleanup_ozon_sync_logs()
RETURNS TABLE (
  deleted_count BIGINT,
  total_time_ms BIGINT,
  batches_processed INT
)
LANGUAGE plpgsql
AS $$
DECLARE
  v_deleted_count BIGINT := 0;
  v_batch_count INT := 0;
  v_rows_deleted INT;
  v_start_time TIMESTAMP;
  v_cutoff_date TIMESTAMPTZ;
  v_max_batches INT := 100;
BEGIN
  v_start_time := clock_timestamp();
  v_cutoff_date := NOW() - INTERVAL '14 days';  -- ‚Üê –ò–ó–ú–ï–ù–ò–õ–ò –ó–î–ï–°–¨

  -- ... –æ—Å—Ç–∞–ª—å–Ω–æ–π –∫–æ–¥ —Ñ—É–Ω–∫—Ü–∏–∏ —Ç–∞–∫–æ–π –∂–µ
END;
$$;
```

### –ò–∑–º–µ–Ω–∏—Ç—å —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ cron job

–ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –æ—á–∏—Å—Ç–∫–∞ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è **–∫–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ 03:00 UTC**. –ß—Ç–æ–±—ã –∏–∑–º–µ–Ω–∏—Ç—å:

```sql
-- –£–¥–∞–ª–∏—Ç—å —Å—Ç–∞—Ä–æ–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ
SELECT cron.unschedule('cleanup-ozon-sync-logs-daily');

-- –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤–æ–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –∫–∞–∂–¥—ã–µ 12 —á–∞—Å–æ–≤)
SELECT cron.schedule(
  'cleanup-ozon-sync-logs-daily',
  '0 */12 * * *',  -- –ö–∞–∂–¥—ã–µ 12 —á–∞—Å–æ–≤
  $$SELECT public.cleanup_ozon_sync_logs();$$
);
```

**–ü—Ä–∏–º–µ—Ä—ã —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–π:**
- `0 3 * * *` - –∫–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ 03:00
- `0 */12 * * *` - –∫–∞–∂–¥—ã–µ 12 —á–∞—Å–æ–≤
- `0 2 * * 0` - –∫–∞–∂–¥–æ–µ –≤–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ –≤ 02:00
- `0 0 1 * *` - 1-–≥–æ —á–∏—Å–ª–∞ –∫–∞–∂–¥–æ–≥–æ –º–µ—Å—è—Ü–∞ –≤ 00:00

---

## üö® FAQ

### Q: –ë–µ–∑–æ–ø–∞—Å–Ω–æ –ª–∏ —É–¥–∞–ª—è—Ç—å —ç—Ç–∏ –ª–æ–≥–∏?

**A:** –î–∞! –¢–∞–±–ª–∏—Ü–∞ `ozon_sync` —Å–æ–¥–µ—Ä–∂–∏—Ç —Ç–æ–ª—å–∫–æ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –ª–æ–≥–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏. –≠—Ç–æ –Ω–µ —Ä–∞–±–æ—á–∏–µ –¥–∞–Ω–Ω—ã–µ. –õ–æ–≥–∏ –Ω—É–∂–Ω—ã —Ç–æ–ª—å–∫–æ –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ –ø—Ä–æ–±–ª–µ–º –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ –Ω–µ—Å–∫–æ–ª—å–∫–æ –¥–Ω–µ–π.

### Q: –ß—Ç–æ –µ—Å–ª–∏ –≤–æ –≤—Ä–µ–º—è —É–¥–∞–ª–µ–Ω–∏—è –ø—Ä–æ–∏–∑–æ–π–¥—ë—Ç –æ—à–∏–±–∫–∞?

**A:** –°–∫—Ä–∏–ø—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç –±–∞—Ç—á–∞–º–∏, –ø–æ—ç—Ç–æ–º—É —á–∞—Å—Ç–∏—á–Ω–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ –±–µ–∑–æ–ø–∞—Å–Ω–æ. –ü—Ä–æ—Å—Ç–æ –∑–∞–ø—É—Å—Ç–∏—Ç–µ —Å–∫—Ä–∏–ø—Ç –µ—â—ë —Ä–∞–∑ - –æ–Ω –ø—Ä–æ–¥–æ–ª–∂–∏—Ç —Å —Ç–æ–≥–æ –º–µ—Å—Ç–∞, –≥–¥–µ –æ—Å—Ç–∞–Ω–æ–≤–∏–ª—Å—è.

### Q: –ü–æ—á–µ–º—É –Ω–µ —É–¥–∞–ª—è—é—Ç—Å—è –≤—Å–µ –ª–æ–≥–∏ —Å—Ä–∞–∑—É?

**A:** –£–¥–∞–ª–µ–Ω–∏–µ –º–∏–ª–ª–∏–æ–Ω–æ–≤ –∑–∞–ø–∏—Å–µ–π –∑–∞ –æ–¥–∏–Ω —Ä–∞–∑ –≤—ã–∑—ã–≤–∞–µ—Ç timeout –≤ Supabase. –ë–∞—Ç—á-—É–¥–∞–ª–µ–Ω–∏–µ –ø–æ 10k –∑–∞–ø–∏—Å–µ–π –±–µ–∑–æ–ø–∞—Å–Ω–æ –∏ –Ω–µ —Å–æ–∑–¥–∞—ë—Ç –Ω–∞–≥—Ä—É–∑–∫—É –Ω–∞ –ë–î.

### Q: –û—Å–≤–æ–±–æ–¥–∏—Ç—Å—è –ª–∏ –º–µ—Å—Ç–æ –≤ –ë–î —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ —É–¥–∞–ª–µ–Ω–∏—è?

**A:** –ß–∞—Å—Ç–∏—á–Ω–æ. PostgreSQL –ø–æ–º–µ—á–∞–µ—Ç —É–¥–∞–ª—ë–Ω–Ω—ã–µ –∑–∞–ø–∏—Å–∏ –∫–∞–∫ "–º—ë—Ä—Ç–≤—ã–µ", –Ω–æ –Ω–µ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –º–µ—Å—Ç–æ –û–° —Å—Ä–∞–∑—É. –î–ª—è –ø–æ–ª–Ω–æ–≥–æ –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏—è –º–µ—Å—Ç–∞ –∑–∞–ø—É—Å—Ç–∏—Ç–µ:

```sql
VACUUM FULL public.ozon_sync;
```

‚ö†Ô∏è **–í–ù–ò–ú–ê–ù–ò–ï:** `VACUUM FULL` –±–ª–æ–∫–∏—Ä—É–µ—Ç —Ç–∞–±–ª–∏—Ü—É –Ω–∞ –≤—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è (~5-10 –º–∏–Ω—É—Ç). –ó–∞–ø—É—Å–∫–∞–π—Ç–µ –≤ –Ω–µ—Ä–∞–±–æ—á–µ–µ –≤—Ä–µ–º—è.

–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞ (–Ω–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç, –Ω–æ –º–µ–¥–ª–µ–Ω–Ω–µ–µ):
```sql
VACUUM public.ozon_sync;
```

### Q: –ú–æ–∂–Ω–æ –ª–∏ –∏–∑–º–µ–Ω–∏—Ç—å —Ä–∞–∑–º–µ—Ä –±–∞—Ç—á–∞?

**A:** –î–∞, –≤ —Ñ—É–Ω–∫—Ü–∏–∏ `cleanup_ozon_sync_logs()` –∏–∑–º–µ–Ω–∏—Ç–µ –∑–Ω–∞—á–µ–Ω–∏–µ `LIMIT 10000` –Ω–∞ –Ω—É–∂–Ω–æ–µ. –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º –Ω–µ –±–æ–ª—å—à–µ 50000 –∑–∞ –±–∞—Ç—á.

### Q: –ö–∞–∫ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç?

**A:** –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏—Å—Ç–æ—Ä–∏—é –∑–∞–ø—É—Å–∫–æ–≤:

```sql
SELECT
  start_time,
  status,
  return_message
FROM cron.job_run_details
WHERE jobname = 'cleanup-ozon-sync-logs-daily'
ORDER BY start_time DESC
LIMIT 5;
```

---

## üìÅ –§–∞–π–ª—ã

1. **CLEANUP_OZON_SYNC_LOGS.sql** - –û–¥–Ω–æ—Ä–∞–∑–æ–≤–∞—è –æ—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –ª–æ–≥–æ–≤ (–∑–∞–ø—É—Å—Ç–∏—Ç–µ –°–ï–ô–ß–ê–°)
2. **supabase/migrations/20260119_cleanup_ozon_sync_logs.sql** - –ú–∏–≥—Ä–∞—Ü–∏—è –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –æ—á–∏—Å—Ç–∫–∏ (–ø—Ä–∏–º–µ–Ω–∏—Ç–µ –û–î–ò–ù –†–ê–ó)
3. **–ò–ù–°–¢–†–£–ö–¶–ò–Ø_–û–ß–ò–°–¢–ö–ê_–õ–û–ì–û–í.md** - –≠—Ç–∞ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è

---

## ‚úÖ –ß–µ–∫-–ª–∏—Å—Ç

- [ ] –ó–∞–ø—É—Å—Ç–∏—Ç—å `CLEANUP_OZON_SYNC_LOGS.sql` –¥–ª—è –æ–¥–Ω–æ—Ä–∞–∑–æ–≤–æ–π –æ—á–∏—Å—Ç–∫–∏
- [ ] –ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é `20260119_cleanup_ozon_sync_logs.sql`
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ cron job —Å–æ–∑–¥–∞–Ω
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–∞–∑–º–µ—Ä –ë–î —á–µ—Ä–µ–∑ –Ω–µ–¥–µ–ª—é
- [ ] (–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) –ó–∞–ø—É—Å—Ç–∏—Ç—å `VACUUM FULL` –¥–ª—è –ø–æ–ª–Ω–æ–≥–æ –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏—è –º–µ—Å—Ç–∞

---

**–ê–≤—Ç–æ—Ä:** Claude Code
**–î–∞—Ç–∞:** 2026-01-19
**–í–µ—Ä—Å–∏—è:** 1.0
