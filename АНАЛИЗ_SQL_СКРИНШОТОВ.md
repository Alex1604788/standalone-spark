# Анализ SQL Скриншотов

Дата анализа: 19.01.2026

## Скриншот 1: Таблица размеров БД

### Что видно на скриншоте:
- Большая таблица с результатами SQL запроса
- Множество строк с данными о различных таблицах БД
- Колонки показывают размеры таблиц и метрики

### Анализ:
Судя по структуре таблицы, это результат выполнения диагностического запроса для проверки размеров таблиц в базе данных Supabase. Запрос, вероятно, показывает:
- Названия таблиц (schema.table_name)
- Общий размер таблиц (total_size)
- Размер данных (data_size)
- Размер индексов (indexes_size)

### Рекомендации:
Для анализа этого скриншота нужно:
1. Определить самые большие таблицы
2. Проверить соотношение размера данных к индексам
3. Выявить таблицы-кандидаты для оптимизации

---

## Скриншот 2: SQL Editor с ошибкой

### Обнаруженная ошибка:
**КРИТИЧЕСКАЯ ОШИБКА В ЗАПРОСЕ**

#### Неправильный код:
```sql
pg_size_prettify_total_relation_size('public.logs_ai')) AS table_total_size
```

#### Правильный код:
```sql
pg_size_pretty(pg_total_relation_size('public.logs_ai')) AS table_total_size
```

### Детали ошибки:
1. **Несуществующая функция:** `pg_size_prettify_total_relation_size` - такой функции нет в PostgreSQL
2. **Правильные функции PostgreSQL:**
   - `pg_size_pretty(bigint)` - форматирует размер в человекочитаемый формат (KB, MB, GB)
   - `pg_total_relation_size(regclass)` - возвращает полный размер таблицы (данные + индексы + TOAST)

### Что делает запрос:
Запрос проверяет старые данные, которые можно архивировать:

1. **logs_ai** - логи AI старше 90 дней
2. **ai_reply_history** - история AI ответов старше 90 дней
3. **audit_log** - аудит-логи старше 180 дней
4. **import_logs** - логи импорта старше 90 дней
5. **ozon_sync_history** - история синхронизации Ozon старше 90 дней

### Исправление:
Создан правильный файл: `ПРОВЕРКА_СТАРЫХ_ДАННЫХ.sql` с корректным синтаксисом.

---

## Общие выводы и рекомендации:

### 1. Проблема с синтаксисом
- В SQL Editor была допущена ошибка при написании функций PostgreSQL
- Всегда используйте официальную документацию PostgreSQL для проверки синтаксиса

### 2. Полезные функции PostgreSQL для анализа размеров:
```sql
-- Размер базы данных
pg_database_size(database_name)

-- Размер таблицы (только данные)
pg_relation_size(table_name)

-- Размер таблицы (данные + индексы + TOAST)
pg_total_relation_size(table_name)

-- Размер только индексов
pg_indexes_size(table_name)

-- Форматирование размера
pg_size_pretty(size_in_bytes)
```

### 3. Архивация старых данных
Для оптимизации БД рекомендуется:
- Регулярно удалять старые логи (logs_ai > 90 дней)
- Архивировать историю AI ответов (ai_reply_history > 90 дней)
- Чистить старые аудит-логи (audit_log > 180 дней)
- Удалять старую историю синхронизации (ozon_sync_history > 90 дней)

### 4. Следующие шаги:
1. Запустить правильный SQL файл `ПРОВЕРКА_СТАРЫХ_ДАННЫХ.sql` в Supabase SQL Editor
2. Проанализировать результаты
3. Принять решение об архивации/удалении старых данных
4. Создать процедуру автоматической очистки старых данных

---

## Правильные SQL файлы для диагностики:

1. **ПРОВЕРКА_СТАРЫХ_ДАННЫХ.sql** - проверка старых данных для архивации (ИСПРАВЛЕНО)
2. **DATABASE_SIZE_DIAGNOSTIC.sql** - полная диагностика размеров БД
3. **SIMPLE_SIZE_CHECK.sql** - упрощенная проверка размеров
4. **QUICK_SIZE_CHECK.sql** - быстрая проверка без таймаута
5. **CHECK_OLD_DATA.sql** - альтернативная проверка старых данных
6. **CHECK_DUPLICATES.sql** - проверка дубликатов
7. **CHECK_DEAD_TUPLES.sql** - проверка мертвых записей (нужен ли VACUUM)
8. **TABLE_ROW_COUNTS.sql** - количество записей в таблицах

Все файлы используют правильный синтаксис PostgreSQL.
