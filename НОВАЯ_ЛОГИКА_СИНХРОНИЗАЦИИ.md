# НОВАЯ ЛОГИКА СИНХРОНИЗАЦИИ OZON

VERSION: 2026-01-16-v1

## ЧТО ИЗМЕНИЛОСЬ

### Старая логика (ПРОБЛЕМНАЯ):
- **Каждые 2 часа** - загрузка **ВСЕХ** отзывов и вопросов с начала времен
- Нет синхронизации чатов
- При 5000 отзывов → 60,000 API запросов в день к OZON!

### Новая логика (ОПТИМИЗИРОВАННАЯ):
1. **Каждые 10 минут** - инкрементальная синхронизация (отзывы, вопросы, чаты за последние 2 дня)
2. **Раз в неделю** - полная синхронизация (отзывы, вопросы, чаты за 14 дней)
3. **Ручная кнопка "Синхронизировать"** - загрузка за последние 7 дней

## ПОДРОБНАЯ ЛОГИКА

### 1. Инкрементальная синхронизация (каждые 10 минут)

**Cron job:** `sync-ozon-incremental`
**Периодичность:** `*/10 * * * *` (каждые 10 минут)
**Данные:** За последние 2 дня

```
Каждые 10 минут:
  └─> Для каждого активного OZON маркетплейса:
      ├─> Синхронизация отзывов (days_back=2)
      ├─> Синхронизация вопросов (days_back=2)
      └─> Синхронизация активных чатов
```

**Зачем?** Быстро ловить новые отзывы/вопросы/чаты без большой нагрузки на API

### 2. Полная синхронизация (раз в неделю)

**Cron job:** `sync-ozon-weekly`
**Периодичность:** `0 3 * * 0` (каждое воскресенье в 03:00 UTC)
**Данные:** За последние 14 дней

```
Каждое воскресенье в 03:00:
  └─> Для каждого активного OZON маркетплейса:
      ├─> Синхронизация отзывов (days_back=14)
      ├─> Синхронизация вопросов (days_back=14)
      └─> Синхронизация активных чатов
```

**Зачем?** Гарантия что ничего не пропущено за последние 2 недели

### 3. Ручная синхронизация (кнопка в UI)

**Кнопка:** "Синхронизировать"
**Расположение:** Страница "Отзывы и вопросы"
**Данные:** За последние 7 дней

```
При нажатии кнопки:
  └─> Для каждого активного OZON маркетплейса:
      ├─> Синхронизация отзывов (days_back=7)
      ├─> Синхронизация вопросов (days_back=7)
      └─> (чаты НЕ синхронизируются через UI кнопку)
```

**Зачем?** Для принудительной загрузки если что-то пропустили

### 4. Публикация ответов (БЕЗ ИЗМЕНЕНИЙ)

**Cron job:** `process-scheduled-replies`
**Периодичность:** `* * * * *` (каждую минуту)
**Действие:** Отправка ответов со статусом `scheduled` в OZON API

### 5. Автогенерация ответов (БЕЗ ИЗМЕНЕНИЙ)

**Cron job:** `auto-generate-drafts-cron`
**Периодичность:** `*/5 * * * *` (каждые 5 минут)
**Действие:** Генерация ответов для неотвеченных отзывов

## ПРЕИМУЩЕСТВА НОВОЙ ЛОГИКИ

### Снижение нагрузки на OZON API:
**Было:**
- 5000 отзывов × 12 синхронизаций в сутки = **60,000 запросов/день**

**Стало:**
- Инкрементальная (2 дня): ~50 новых отзывов × 144 раза = **7,200 запросов/день**
- Полная (14 дней): ~200 отзывов × 1 раз в неделю = **200 запросов/неделю**
- **Итого: ~8,000 запросов/день** (сниж в 7.5 раз!)

### Быстрая доставка новых данных:
- Новые отзывы появляются в системе **в течение 10 минут**
- Старая логика: в течение 2 часов

### Синхронизация чатов:
- Раньше: только вручную
- Теперь: автоматически каждые 10 минут

## ИНСТРУКЦИЯ ПО ПРИМЕНЕНИЮ

### Шаг 1: Задеплоить обновленную Edge Function

```bash
cd supabase/functions/sync-ozon
supabase functions deploy sync-ozon
```

### Шаг 2: Применить SQL миграцию

1. Откройте Supabase SQL Editor
2. Откройте файл `supabase/migrations/20260116_setup_new_ozon_sync_logic.sql`
3. Скопируйте весь SQL код
4. Вставьте в SQL Editor и нажмите "Run"

### Шаг 3: Проверить что cron jobs созданы

```sql
SELECT
  jobname,
  schedule,
  active,
  jobid
FROM cron.job
WHERE jobname IN ('sync-ozon-incremental', 'sync-ozon-weekly')
ORDER BY jobname;
```

Должны увидеть:
- `sync-ozon-incremental`: `*/10 * * * *` (каждые 10 минут)
- `sync-ozon-weekly`: `0 3 * * 0` (каждое воскресенье в 03:00)

### Шаг 4: Проверить работу

1. Дождитесь ближайших 10 минут (например, 14:00, 14:10, 14:20)
2. Проверьте что новые отзывы появились в системе
3. Проверьте логи в Supabase Dashboard → Edge Functions → sync-ozon

## МОНИТОРИНГ

### Проверка последней синхронизации:

```sql
SELECT
  id,
  name,
  last_sync_at,
  type
FROM marketplaces
WHERE type = 'ozon'
  AND is_active = true;
```

### Проверка активных cron jobs:

```sql
SELECT *
FROM cron.job
WHERE active = true
ORDER BY jobname;
```

### Проверка истории синхронизации:

```sql
SELECT *
FROM ozon_sync_history
ORDER BY synced_at DESC
LIMIT 20;
```

## ОТКАТ НА СТАРУЮ ЛОГИКУ (если нужно)

Если что-то пошло не так, можно вернуть старую логику:

```sql
-- Удалить новые cron jobs
SELECT cron.unschedule('sync-ozon-incremental');
SELECT cron.unschedule('sync-ozon-weekly');

-- Восстановить старый (каждые 2 часа, без фильтра по дате)
SELECT cron.schedule(
  'sync-ozon-marketplaces',
  '0 */2 * * *',
  $$...$$  -- см. старую миграцию
);
```

## FAQ

### Q: Почему 2 дня для инкрементальной синхронизации?
**A:** Запас на случай если какой-то из запусков пропустит данные. 2 дня гарантируют что ничего не потеряем.

### Q: Почему 14 дней для полной синхронизации?
**A:** Согласно требованиям OZON, отзывы нужно отвечать в течение 14 дней. Полная синхронизация гарантирует что мы не пропустили ничего важного.

### Q: Можно ли изменить периодичность?
**A:** Да, можно изменить cron schedule в миграции. Например:
- Инкрементальная: `*/5 * * * *` (каждые 5 минут)
- Полная: `0 3 * * 1` (каждый понедельник в 03:00)

### Q: Что делать если синхронизация не работает?
**A:**
1. Проверьте что cron jobs активны
2. Проверьте что Edge Function sync-ozon задеплоена
3. Проверьте логи в Supabase Dashboard
4. Проверьте что у маркетплейса `sync_mode='api'` и заполнены API ключи

## ИЗМЕНЁННЫЕ ФАЙЛЫ

1. `supabase/functions/sync-ozon/index.ts` - добавлена поддержка `days_back`
2. `supabase/migrations/20260116_setup_new_ozon_sync_logic.sql` - новые cron jobs
3. `src/pages/Reviews.tsx` - кнопка "Синхронизировать" использует `days_back=7`
