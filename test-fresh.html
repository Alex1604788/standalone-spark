<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>OZON Sync 23-24.12</title>
    <style>
        body { font-family: Arial; padding: 20px; max-width: 800px; margin: 0 auto; }
        button { padding: 15px 25px; font-size: 18px; cursor: pointer; margin: 10px 0; background: #4CAF50; color: white; border: none; border-radius: 5px; }
        button:disabled { background: #ccc; }
        .log { background: #f5f5f5; padding: 15px; margin: 10px 0; min-height: 400px; max-height: 600px; overflow-y: auto; font-family: monospace; font-size: 13px; border: 1px solid #ddd; }
        .success { color: green; font-weight: bold; }
        .error { color: red; font-weight: bold; }
    </style>
</head>
<body>
    <h1>üöÄ OZON Performance - –¢–µ—Å—Ç 23-24.12.2025</h1>
    <p><b>–ú–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å:</b> –ö–†–ê–§–¢–ú–ê–ù</p>
    <p><b>–ü–µ—Ä–∏–æ–¥:</b> –°–≤–µ–∂–∏–µ –¥–∞–Ω–Ω—ã–µ –∑–∞ 23-24 –¥–µ–∫–∞–±—Ä—è</p>

    <button onclick="runSync()" id="syncBtn">‚ñ∂Ô∏è –ó–∞–ø—É—Å—Ç–∏—Ç—å —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é</button>
    <button onclick="checkData()" id="checkBtn">üìä –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–∞–Ω–Ω—ã–µ</button>

    <div class="log" id="log"></div>

    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm'

        const supabase = createClient(
            'https://bkmicyguzlwampuindff.supabase.co',
            'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJrbWljeWd1emx3YW1wdWluZGZmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ2OTUwMjMsImV4cCI6MjA4MDI3MTAyM30.v8BlZ_k8DxdSmh5Ao1da7GHurSshE1cBsMxdfQCp9PQ'
        );

        const MARKETPLACE_ID = '84b1d0f5-6750-407c-9b04-28c051972162';

        function log(msg, type = '') {
            const el = document.getElementById('log');
            const time = new Date().toLocaleTimeString();
            const className = type === 'success' ? 'success' : type === 'error' ? 'error' : '';
            el.innerHTML += `<div class="${className}">[${time}] ${msg}</div>`;
            el.scrollTop = el.scrollHeight;
        }

        window.runSync = async () => {
            const btn = document.getElementById('syncBtn');
            btn.disabled = true;
            log('üîÑ –ù–∞—á–∏–Ω–∞–µ–º —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é...', 'success');
            log(`–ú–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å: –ö–†–ê–§–¢–ú–ê–ù (${MARKETPLACE_ID})`);
            log(`–ü–µ—Ä–∏–æ–¥: 2025-12-23 ‚Üí 2025-12-24`);
            log('');

            try {
                const { data, error } = await supabase.functions.invoke('sync-ozon-performance', {
                    body: {
                        marketplace_id: MARKETPLACE_ID,
                        start_date: '2025-12-23',
                        end_date: '2025-12-24',
                    }
                });

                if (error) throw new Error(error.message);

                log('‚úÖ –°–ò–ù–•–†–û–ù–ò–ó–ê–¶–ò–Ø –ó–ê–í–ï–†–®–ï–ù–ê!', 'success');
                log('');
                log('üì¶ –†–µ–∑—É–ª—å—Ç–∞—Ç:', 'success');
                log(JSON.stringify(data, null, 2));
                log('');
                log('üëâ –¢–µ–ø–µ—Ä—å –Ω–∞–∂–º–∏ "–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–∞–Ω–Ω—ã–µ"');

            } catch (err) {
                log('', 'error');
                log('‚ùå –û–®–ò–ë–ö–ê: ' + err.message, 'error');
            } finally {
                btn.disabled = false;
            }
        };

        window.checkData = async () => {
            const btn = document.getElementById('checkBtn');
            btn.disabled = true;
            log('');
            log('üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–∞–Ω–Ω—ã–µ –∑–∞ 23-24.12.2025...');

            try {
                const { data, error } = await supabase
                    .from('ozon_performance_daily')
                    .select('*')
                    .eq('marketplace_id', MARKETPLACE_ID)
                    .gte('stat_date', '2025-12-23')
                    .lte('stat_date', '2025-12-24')
                    .order('stat_date')
                    .order('sku');

                if (error) throw error;

                if (!data || data.length === 0) {
                    log('‚ö†Ô∏è –î–∞–Ω–Ω—ã—Ö –ù–ï–¢!', 'error');
                    return;
                }

                log(`‚úÖ –ù–∞–π–¥–µ–Ω–æ ${data.length} –∑–∞–ø–∏—Å–µ–π`, 'success');
                log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');

                const bySKU = {};
                data.forEach(row => {
                    if (!bySKU[row.sku]) {
                        bySKU[row.sku] = { orders: 0, orders_model: 0, revenue: 0, campaigns: [] };
                    }
                    bySKU[row.sku].orders += row.orders || 0;
                    bySKU[row.sku].orders_model += row.orders_model || 0;
                    bySKU[row.sku].revenue += parseFloat(row.revenue || 0);
                    bySKU[row.sku].campaigns.push(row.campaign_name);
                });

                Object.keys(bySKU).forEach(sku => {
                    const s = bySKU[sku];
                    const total = s.orders + s.orders_model;
                    log(`SKU: ${sku}`);
                    log(`  –ó–∞–∫–∞–∑—ã: ${s.orders} + –ú–æ–¥–µ–ª–∏: ${s.orders_model} = ${total}`);
                    log(`  –í—ã—Ä—É—á–∫–∞: ${s.revenue.toFixed(2)}‚ÇΩ`);
                    log(`  –ö–∞–º–ø–∞–Ω–∏–∏: ${s.campaigns.join(', ')}`);
                    log('');
                });

                log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');
                log('‚úÖ –ü–†–û–í–ï–†–ö–ê –ó–ê–í–ï–†–®–ï–ù–ê', 'success');

            } catch (err) {
                log('‚ùå –û–®–ò–ë–ö–ê: ' + err.message, 'error');
            } finally {
                btn.disabled = false;
            }
        };

        log('‚úÖ –ì–æ—Ç–æ–≤–æ –∫ —Ä–∞–±–æ—Ç–µ!', 'success');
        log('üëâ –ù–∞–∂–º–∏ "–ó–∞–ø—É—Å—Ç–∏—Ç—å —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é"');
        log('');
    </script>
</body>
</html>
